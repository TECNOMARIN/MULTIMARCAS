<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gets Solutions Pos | Gestión empresarial V2.20</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #6d28d9 0%, #3b82f6 100%);
      --gets-purple: #9333ea;
      --gets-dark: #1e293b;
      --gets-light: #f8fafc;
      --gets-red: #ef4444;
      --gets-green: #10b981;
    }
    body { background: var(--primary-gradient); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
    
    .main-card { width: 100%; max-width: 500px; background: white; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3); overflow: hidden; display: none; transition: max-width 0.4s ease; }
    .main-card.wide { max-width: 1400px; } 
    
    /* Navegación */
    .brand-header { padding: 1.5rem; text-align: center; border-bottom: 1px solid #f1f5f9; background: white; }
    .brand-logo { max-height: 45px; }
    .custom-tabs { display: flex; background: #fafafa; border-bottom: 1px solid #f1f5f9; }
    .tab-item { flex: 1; padding: 1rem 0.5rem; text-align: center; cursor: pointer; color: #94a3b8; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; border-bottom: 3px solid transparent; transition: 0.3s; }
    .tab-item.is-active { color: var(--gets-purple); border-bottom-color: var(--gets-purple); background: white; }

    /* Vistas */
    .section-view { display: none; padding: 1.5rem; }
    .is-active-view { display: block; }
    .admin-label { font-size: 0.7rem; font-weight: 800; color: var(--gets-purple); text-transform: uppercase; margin-bottom: 0.75rem; display: block; }
    .box-admin { border: 1px solid #f1f5f9; padding: 1.25rem; border-radius: 12px; margin-bottom: 1.25rem; background: #f8fafc; }

    /* Formularios y Calculadora */
    .solicitante-section { border-left: 4px solid var(--gets-purple); padding: 0.5rem 1rem; margin-bottom: 1.5rem; background: #fafafa; border-radius: 0 8px 8px 0; }
    .res-grid { background: #1e293b; border-radius: 15px; padding: 1.25rem; margin-top: 1.5rem; color: white; text-align: center; display: flex; gap: 10px; }
    .res-item { flex: 1; }
    .res-item p:first-child { font-size: 0.65rem; color: #94a3b8; font-weight: 700; text-transform: uppercase; }
    .res-item p:last-child { font-size: 1.3rem; font-weight: 800; }

    /* Layout Consultas */
    .query-layout { display: flex; gap: 1.5rem; min-height: 550px; }
    .query-sidebar { width: 200px; border-right: 1px solid #f1f5f9; padding-right: 10px; }
    .query-content { flex: 1; overflow: hidden; }
    .menu-list a { border-radius: 8px; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem; padding: 0.75rem; }
    .menu-list a.is-active { background: var(--gets-purple); color: white !important; }
    
    .table-container { border-radius: 12px; border: 1px solid #f1f5f9; max-height: 600px; overflow: auto; background: white; }
    .table { font-size: 0.75rem; white-space: nowrap; width: 100%; }
    .table.is-clickable tbody tr { cursor: pointer; transition: background 0.2s; }
    .table.is-clickable tbody tr:hover { background-color: #f5f3ff !important; }
    .table thead th { position: sticky; top: 0; background: #f8fafc; z-index: 5; border-bottom: 2px solid #e2e8f0; padding: 12px; font-weight: 800; color: #475569; }

    /* Pie de página */
    .footer-v { text-align: center; padding: 1rem; font-size: 0.7rem; color: #94a3b8; background: #f8fafc; border-top: 1px solid #f1f5f9; font-weight: 600; }

    /* Totales */
    .summary-box { background: #fdf2ff; border: 1px solid #e9d5ff; border-radius: 15px; padding: 1.5rem; margin-top: 1.5rem; display: flex; justify-content: space-around; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    .summary-item { text-align: center; }
    .summary-item p:first-child { font-size: 0.7rem; color: #6b21a8; font-weight: 700; text-transform: uppercase; margin-bottom: 0.4rem; }
    .summary-item p:last-child { font-size: 1.4rem; color: var(--gets-dark); font-weight: 800; }

    /* Botones Modernos */
    .button.is-purple { background: var(--gets-purple); color: white; font-weight: 700; border: none; }
    .button.is-purple:hover { background: #7e22ce; color: white; }

    .btn-modern {
        border-radius: 10px;
        font-weight: 700;
        transition: all 0.2s ease;
        padding: 0.6rem 1.5rem;
        height: auto;
        font-size: 0.85rem;
    }

    .btn-modern.is-cancel {
        background: #f1f5f9;
        color: #64748b;
        border: 1px solid #e2e8f0;
    }

    .btn-modern.is-cancel:hover {
        background: #e2e8f0;
        color: #475569;
        border-color: #cbd5e1;
    }

    .btn-modern.is-save {
        background: var(--primary-gradient);
        color: white;
        border: none;
        box-shadow: 0 4px 10px rgba(109, 40, 217, 0.25);
    }

    .btn-modern.is-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(109, 40, 217, 0.35);
        color: white;
    }

    .btn-modern.is-danger-modern {
        background: #fff;
        color: var(--gets-red);
        border: 1px solid #fee2e2;
    }

    .btn-modern.is-danger-modern:hover {
        background: var(--gets-red);
        color: white;
        border-color: var(--gets-red);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(239, 68, 68, 0.25);
    }

    /* Toasts/Notificaciones */
    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
    .toast { 
        background: white; border-radius: 12px; padding: 1rem 1.5rem; min-width: 280px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
        display: flex; align-items: center; gap: 12px; margin-bottom: 10px;
        transform: translateX(120%); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border-left: 5px solid var(--gets-purple);
    }
    .toast.is-active { transform: translateX(0); }
    .toast.is-success { border-left-color: var(--gets-green); }
    .toast.is-error { border-left-color: var(--gets-red); }
    .toast-icon { display: flex; align-items: center; justify-content: center; }

    .modal-card-foot {
        justify-content: flex-end;
        gap: 12px;
        background-color: #f8fafc;
        border-top: 1px solid #f1f5f9;
        padding: 1rem 1.5rem;
    }

    .btn-delete-row { color: #f87171; cursor: pointer; transition: color 0.2s; display: flex; align-items: center; justify-content: center; }
    .btn-delete-row:hover { color: #dc2626; }

    @media screen and (max-width: 768px) {
      .query-layout { flex-direction: column; }
      .query-sidebar { width: 100%; border-right: none; border-bottom: 1px solid #f1f5f9; padding-bottom: 1rem; }
      .summary-box { flex-direction: column; gap: 1.5rem; }
      .modal-card-foot { flex-direction: column-reverse; gap: 8px; }
      .modal-card-foot .button { width: 100%; }
    }
  </style>
</head>
<body>

  <div id="loading" class="loader-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <div class="button is-loading is-large is-white"></div>
    <p class="mt-4 has-text-grey">Sincronizando con Gets Solutions Pos...</p>
  </div>

  <div id="toast-container"></div>

  <!-- LOGIN -->
  <div id="login-container" class="main-card" style="display: block;">
    <div class="brand-header"><img src="https://appgets.solutions/img/logoempresa.png" alt="Logo" class="brand-logo"></div>
    <div id="login-view" style="padding: 3rem 2rem;">
      <div style="text-align: center; margin-bottom: 2rem;">
        <div style="color: var(--gets-purple); background: #f5f3ff; width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
            <i data-lucide="shield-check" style="width:32px; height:32px;"></i>
        </div>
        <h2 class="title is-4 mb-2">Ingreso Seguro</h2>
      </div>
      <div class="field w-full" style="width:100%">
        <label class="label is-small">Tienda / Aliado</label>
        <div class="control has-icons-left">
          <input id="login-user" class="input is-medium" type="text" placeholder="Nombre Comercial">
          <span class="icon is-small is-left"><i data-lucide="store"></i></span>
        </div>
      </div>
      <div class="field w-full mt-4" style="width:100%">
        <label class="label is-small">Contraseña</label>
        <div class="control has-icons-left">
          <input id="login-pass" class="input is-medium" type="password" placeholder="••••••••" onkeypress="if(event.key==='Enter') attemptLogin()">
          <span class="icon is-small is-left"><i data-lucide="key"></i></span>
        </div>
      </div>
      <button class="button is-purple is-fullwidth is-medium mt-6" onclick="attemptLogin()">Ingresar</button>
      <p id="login-error" class="help is-danger is-hidden mt-4 has-text-centered">Credenciales incorrectas.</p>
    </div>
    <div class="footer-v">Gets Solutions Pos | Gestión empresarial V2.20</div>
  </div>

  <!-- APP PRINCIPAL -->
  <div id="app-container" class="main-card">
    <div class="brand-header is-flex is-justify-content-space-between is-align-items-center">
      <img src="https://appgets.solutions/img/logoempresa.png" alt="Logo" class="brand-logo">
      <button class="button is-ghost is-small has-text-danger" onclick="location.reload()">
        <span class="icon is-small"><i data-lucide="log-out"></i></span><span>Salir</span>
      </button>
    </div>

    <div class="custom-tabs">
      <div id="t-sim" class="tab-item is-active" onclick="switchView('sim')">Calculadora</div>
      <div id="t-adm" class="tab-item" style="display:none;" onclick="switchView('adm')">Configuración</div>
      <div id="t-con" class="tab-item" style="display:none;" onclick="switchView('con')">Consultas</div>
    </div>

    <!-- CALCULADORA -->
    <div id="v-sim" class="section-view is-active-view">
      <div class="solicitante-section">
        <span class="admin-label">Datos del Solicitante</span>
        <div class="columns is-mobile is-multiline mb-0">
          <div class="column is-6 py-1"><input id="in_cc" class="input is-small" placeholder="CC / Documento"></div>
          <div class="column is-6 py-1"><input id="in_celular" class="input is-small" placeholder="Celular"></div>
          <div class="column is-12 py-1"><input id="in_nombre_sol" class="input is-small" placeholder="Nombre completo"></div>
          <div class="column is-12 py-1"><input id="in_correo" class="input is-small" placeholder="Correo electrónico"></div>
        </div>
      </div>
      <div class="field"><label class="label is-small">Tienda</label><div class="select is-fullwidth"><select id="sel_cliente" onchange="handleAllyChange()"></select></div></div>
      <div class="field"><label class="label is-small">Entidad Financiera</label><div class="select is-fullwidth"><select id="sel_financiera" onchange="loadPlanes()"></select></div></div>
      <div class="columns is-mobile mb-0">
        <div class="column"><label class="label is-small">Plan</label><div class="select is-fullwidth"><select id="sel_plan" onchange="loadNumCuotas()"></select></div></div>
        <div class="column"><label class="label is-small">Cuotas</label><div class="select is-fullwidth"><select id="sel_n_cuotas" onchange="calc()"></select></div></div>
      </div>
      <div class="field"><label class="label is-small">Precio del Producto ($)</label><input id="in_precio" class="input is-medium" type="number" placeholder="0.00" oninput="calc()"></div>
      <div class="res-grid">
        <div class="res-item"><p>Total Crédito</p><p id="out_consignar">$ 0</p></div>
        <div class="res-item"><p>Cuota (Aprox.)</p><p id="out_cuota">$ 0</p></div>
      </div>
      <button class="button is-purple is-fullwidth is-medium mt-5" onclick="validateAndSave()">Registrar Simulación</button>
    </div>

    <!-- CONFIGURACIÓN -->
    <div id="v-adm" class="section-view">
      <!-- 1. Registro de Aliados -->
      <div class="box-admin">
        <span class="admin-label">1. Registro de Aliados</span>
        <div class="control has-icons-left mb-2">
            <input id="new_cli_nom" class="input is-small" placeholder="Nombre Aliado">
            <span class="icon is-small is-left"><i data-lucide="store"></i></span>
        </div>
        <div class="field has-addons">
          <div class="control is-expanded has-icons-left">
              <input id="new_cli_pass" class="input is-small" placeholder="Contraseña">
              <span class="icon is-small is-left"><i data-lucide="key"></i></span>
          </div>
          <div class="control"><button class="button is-purple is-small" onclick="apiCall('crearCliente', {nombre: document.getElementById('new_cli_nom').value, contrasena: document.getElementById('new_cli_pass').value})">Registrar</button></div>
        </div>
      </div>

      <!-- 2. Vinculación (RESTAURADA) -->
      <div class="box-admin">
        <span class="admin-label">2. Vinculación (Factores Aliado)</span>
        <div class="columns is-mobile mb-2">
          <div class="column"><div class="select is-fullwidth is-small"><select id="rel_cli_id"></select></div></div>
          <div class="column"><div class="select is-fullwidth is-small"><select id="rel_fin_id"></select></div></div>
        </div>
        <div class="field has-addons">
          <div class="control is-expanded">
            <input id="rel_fac_val" class="input is-small" type="number" step="0.01" placeholder="Factor Asignado">
          </div>
          <div class="control">
            <button class="button is-warning is-small" style="font-weight:700;" onclick="apiCall('asignarFactorCliente', {id_cliente: document.getElementById('rel_cli_id').value, id_financiera: document.getElementById('rel_fin_id').value, factor_cliente: document.getElementById('rel_fac_val').value})">Vincular</button>
          </div>
        </div>
      </div>

      <!-- 3. Registro de Entidades -->
      <div class="box-admin">
        <span class="admin-label">3. Registro de Entidades</span>
        <div class="columns is-mobile mb-2">
          <div class="column is-8">
              <div class="control has-icons-left">
                <input id="new_fin_nom" class="input is-small" placeholder="Nombre Entidad">
                <span class="icon is-small is-left"><i data-lucide="building"></i></span>
              </div>
          </div>
          <div class="column is-4"><input id="new_fin_fac" class="input is-small" type="number" step="0.01" placeholder="Factor"></div>
        </div>
        <button class="button is-info is-fullwidth is-small" style="background:#3b82f6; color:white; font-weight:700;" onclick="apiCall('crearFinanciera', {nombre: document.getElementById('new_fin_nom').value, factor: document.getElementById('new_fin_fac').value})">Guardar Entidad</button>
      </div>

      <!-- 4. Definición de Planes -->
      <div class="box-admin">
        <span class="admin-label">4. Definición de Planes</span>
        <div class="select is-fullwidth is-small mb-2"><select id="plan_fin_id"></select></div>
        <div class="columns is-mobile mb-2">
          <div class="column"><input id="plan_num" class="input is-small" type="number" placeholder="Máx. Cuotas"></div>
          <div class="column"><input id="plan_int" class="input is-small" type="number" step="0.01" placeholder="% Int"></div>
        </div>
        <button class="button is-dark is-fullwidth is-small" onclick="apiCall('crearPlanCuota', {id_financiera: document.getElementById('plan_fin_id').value, numero_cuotas: document.getElementById('plan_num').value, tasa_interes: document.getElementById('plan_int').value, tipo_cuota: 'Mensual'})">Registrar Plan</button>
      </div>
      <button class="button is-light is-fullwidth is-small" onclick="refresh()">Sincronizar Base de Datos</button>
    </div>

    <!-- CONSULTAS -->
    <div id="v-con" class="section-view">
      <div class="query-layout">
        <aside class="query-sidebar">
          <p class="menu-label">Administración</p>
          <ul class="menu-list">
            <li><a id="m-cli" class="is-active" onclick="switchQuery('cli')">Aliados</a></li>
            <li><a id="m-fin" onclick="switchQuery('fin')">Entidades</a></li>
            <li><a id="m-his" onclick="switchQuery('his')">Historial</a></li>
          </ul>
        </aside>
        <main class="query-content">
          <div id="q-cli" class="q-section">
            <span class="admin-label">Aliados Comerciales (Clic para editar)</span>
            <div class="table-container"><table class="table is-fullwidth is-striped is-clickable is-narrow"><thead><tr><th>Nombre</th><th>Clave Acceso</th></tr></thead><tbody id="tb-clientes"></tbody></table></div>
          </div>
          <div id="q-fin" class="q-section" style="display:none;">
            <span class="admin-label">Entidades Financieras (Clic para editar)</span>
            <div class="table-container"><table class="table is-fullwidth is-striped is-clickable is-narrow"><thead><tr><th>Entidad</th><th>Factor Base</th></tr></thead><tbody id="tb-financieras"></tbody></table></div>
          </div>
          <div id="q-his" class="q-section" style="display:none;">
            <span class="admin-label">Historial Hoja SIMULACION</span>
            <div class="columns is-mobile is-multiline mb-2">
              <div class="column is-5"><label class="label is-7 mb-0">Fecha Inicial</label><input id="f-desde" class="input is-small" type="date"></div>
              <div class="column is-5"><label class="label is-7 mb-0">Fecha Final</label><input id="f-hasta" class="input is-small" type="date"></div>
              <div class="column is-2 is-flex is-align-items-flex-end"><button class="button is-purple is-small is-fullwidth" onclick="filterSimulations()"><i data-lucide="filter" style="width:14px;"></i></button></div>
            </div>
            <div class="table-container">
              <table class="table is-fullwidth is-striped is-narrow">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Tienda (Aliado)</th>
                    <th>Entidad</th>
                    <th>CC</th>
                    <th>Nombre Solicitante</th>
                    <th>Correo</th>
                    <th>Celular</th>
                    <th class="has-text-right">Total Crédito</th>
                    <th class="has-text-right">Utilidad</th>
                    <th class="has-text-right">Cuota</th>
                    <th class="has-text-centered">Plazo</th>
                    <th class="has-text-right">Total Pagado</th>
                  </tr>
                </thead>
                <tbody id="tb-simulaciones"></tbody>
              </table>
            </div>

            <div class="summary-box">
              <div class="summary-item"><p>N° Créditos</p><p id="total-count">0</p></div>
              <div class="summary-item"><p>Sumatoria Créditos</p><p id="total-creditos">$ 0</p></div>
              <div class="summary-item"><p>Utilidad Total</p><p id="total-utilidad" style="color: #059669;">$ 0</p></div>
            </div>
          </div>
        </main>
      </div>
    </div>
    <div class="footer-v">Gets Solutions Pos | Gestión empresarial V2.20</div>
  </div>

  <!-- MODAL CONFIRMACIÓN ELIMINACIÓN -->
  <div id="mod-confirm" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card" style="max-width: 400px;">
        <header class="modal-card-head"><p class="modal-card-title is-size-6 has-text-weight-bold">Confirmar Eliminación</p></header>
        <section class="modal-card-body has-text-centered py-5">
            <div style="color: var(--gets-red); margin-bottom: 1rem;"><i data-lucide="alert-triangle" style="width:48px; height:48px;"></i></div>
            <p id="confirm-text" class="is-size-6">¿Estás seguro de que deseas eliminar este registro?</p>
            <p class="is-size-7 has-text-grey mt-2">Esta acción no se puede deshacer.</p>
        </section>
        <footer class="modal-card-foot">
            <button class="button btn-modern is-cancel" onclick="closeConfirm()">Cancelar</button>
            <button id="btn-confirm-exec" class="button btn-modern is-save" style="background: var(--gets-red);">Eliminar</button>
        </footer>
    </div>
  </div>

  <!-- MODAL EDICIÓN ALIADO -->
  <div id="mod-cli" class="modal">
    <div class="modal-background" onclick="closeModals()"></div>
    <div class="modal-card">
      <header class="modal-card-head"><p class="modal-card-title is-size-6 has-text-weight-bold">Editar Aliado Comercial</p></header>
      <section class="modal-card-body">
          <input id="ed-cli-id" type="hidden">
          <div class="field"><label class="label is-small">Nombre de la Tienda</label><input id="ed-cli-nom" class="input is-small"></div>
          <div class="field"><label class="label is-small">Clave de Acceso</label><input id="ed-cli-pass" class="input is-small"></div>
          <hr><span class="admin-label">Factores Asignados por Financiera</span>
          <div id="vinculos-container" class="table-container"></div>
      </section>
      <footer class="modal-card-foot">
          <button class="button btn-modern is-danger-modern mr-auto" onclick="confirmDeleteAliado()">Eliminar Aliado</button>
          <button class="button btn-modern is-cancel" onclick="closeModals()">Cancelar</button>
          <button class="button btn-modern is-save" onclick="saveAliado()">Guardar Cambios</button>
      </footer>
    </div>
  </div>

  <!-- MODAL EDICIÓN ENTIDAD -->
  <div id="mod-fin" class="modal">
    <div class="modal-background" onclick="closeModals()"></div>
    <div class="modal-card" style="width:95%; max-width:700px;">
      <header class="modal-card-head"><p class="modal-card-title is-size-6 has-text-weight-bold">Tasas y Planes de Entidad</p></header>
      <section class="modal-card-body">
          <input id="ed-fin-id" type="hidden">
          <div class="field"><label class="label is-small">Nombre de la Entidad</label><input id="ed-fin-nom" class="input is-small"></div>
          <div class="field"><label class="label is-small">Factor Base de Entidad</label><input id="ed-fin-fac" class="input is-small" type="number" step="0.01"></div>
          <hr><span class="admin-label">Planes Registrados</span>
          <div id="planes-container" class="table-container"></div>
      </section>
      <footer class="modal-card-foot">
          <button class="button btn-modern is-danger-modern mr-auto" onclick="confirmDeleteFinanciera()">Eliminar Entidad</button>
          <button class="button btn-modern is-cancel" onclick="closeModals()">Cerrar</button>
          <button class="button btn-modern is-save" onclick="saveFinanciera()">Actualizar Planes</button>
      </footer>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzH2a6_gdBJ6uEzmms8qneHg5XnpThtWALqEjgZ9YYcEyMdG1ikYWb68POhtVELJdrdRA/exec";
    let db = { clientes: [], financieras: [], cuotas: [], porcentajes: [], simulaciones: [] };
    let currentUser = null;

    window.onload = () => { 
        lucide.createIcons(); 
        setDefaultDates(); 
        refresh(); 
    };

    // --- SISTEMA DE NOTIFICACIONES ---
    function showToast(msg, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast is-${type}`;
        const icon = type === 'success' ? 'check-circle' : 'x-circle';
        toast.innerHTML = `
            <div class="toast-icon" style="color: ${type === 'success' ? 'var(--gets-green)' : 'var(--gets-red)'}">
                <i data-lucide="${icon}"></i>
            </div>
            <div class="toast-content is-size-7 has-text-weight-semibold">${msg}</div>
        `;
        container.appendChild(toast);
        lucide.createIcons();
        setTimeout(() => toast.classList.add('is-active'), 100);
        setTimeout(() => {
            toast.classList.remove('is-active');
            setTimeout(() => toast.remove(), 400);
        }, 3000);
    }

    // --- MODAL CONFIRMACION PERSONALIZADO ---
    let confirmCallback = null;
    function openConfirm(text, callback) {
        document.getElementById('confirm-text').innerText = text;
        document.getElementById('mod-confirm').classList.add('is-active');
        confirmCallback = callback;
        document.getElementById('btn-confirm-exec').onclick = async () => {
            await confirmCallback();
            closeConfirm();
        };
    }
    function closeConfirm() {
        document.getElementById('mod-confirm').classList.remove('is-active');
        confirmCallback = null;
    }

    function setDefaultDates() {
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        const formatDate = (date) => {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            let year = d.getFullYear();
            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;
            return [year, month, day].join('-');
        };
        document.getElementById('f-desde').value = formatDate(firstDay);
        document.getElementById('f-hasta').value = formatDate(now);
    }

    async function refresh() {
      document.getElementById('loading').style.display = 'flex';
      const res = await fetchApi('getData');
      if(res) {
        db = res;
        fill('sel_cliente', db.clientes, 'id_cliente', 'nombre_cliente');
        fill('rel_cli_id', db.clientes, 'id_cliente', 'nombre_cliente', true);
        fill('rel_fin_id', db.financieras, 'id_financiera', 'nombre_financiera', true);
        fill('plan_fin_id', db.financieras, 'id_financiera', 'nombre_financiera', true);
        renderTables();
        document.getElementById('loading').style.display = 'none';
      }
    }

    function attemptLogin() {
      const u = document.getElementById('login-user').value.trim().toLowerCase();
      const p = document.getElementById('login-pass').value;
      const found = db.clientes.find(c => String(c.nombre_cliente).toLowerCase().trim() === u && String(c.contrasena) === p);
      if (found) {
        currentUser = found;
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        const isAdmin = String(currentUser.nombre_cliente).toLowerCase() === 'administrador';
        document.getElementById('sel_cliente').disabled = !isAdmin;
        document.getElementById('sel_cliente').value = currentUser.id_cliente;
        document.getElementById('t-adm').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('t-con').style.display = isAdmin ? 'block' : 'none';
        loadAssignedEntities(currentUser.id_cliente);
        switchView('sim');
      } else {
        document.getElementById('login-error').classList.remove('is-hidden');
      }
    }

    function renderTables() {
      const draw = (id, html) => { const el = document.getElementById(id); if(el) el.innerHTML = html; };
      draw('tb-clientes', db.clientes.map(c => `<tr onclick="openAliado('${c.id_cliente}')"><td>${c.nombre_cliente}</td><td><code>${c.contrasena}</code></td></tr>`).join(''));
      draw('tb-financieras', db.financieras.map(f => `<tr onclick="openFinanciera('${f.id_financiera}')"><td>${f.nombre_financiera}</td><td>${f.factor_financiera}</td></tr>`).join(''));
      filterSimulations(); 
    }

    // --- FUNCIONES MODALES ---

    function openAliado(id) {
        const c = db.clientes.find(x => String(x.id_cliente) === String(id));
        if(!c) return;
        document.getElementById('ed-cli-id').value = c.id_cliente;
        document.getElementById('ed-cli-nom').value = c.nombre_cliente;
        document.getElementById('ed-cli-pass').value = c.contrasena;
        let h = '<table class="table is-fullwidth is-narrow is-bordered"><thead><tr><th>Entidad</th><th>Factor Aliado</th><th class="has-text-centered">Acción</th></tr></thead><tbody>';
        db.financieras.forEach(f => {
            const r = db.porcentajes.find(p => String(p.id_cliente) === String(id) && String(p.id_financiera) === String(f.id_financiera));
            h += `<tr>
                <td class="is-size-7">${f.nombre_financiera}</td>
                <td><input class="input is-small v-fac" data-fin="${f.id_financiera}" type="number" step="0.01" value="${r?r.factor_cliente:''}"></td>
                <td class="has-text-centered">
                    ${r ? `<span class="btn-delete-row" onclick="event.stopPropagation(); confirmDeleteVinculo('${id}', '${f.id_financiera}')" title="Eliminar factor"><i data-lucide="trash-2" style="width:16px;"></i></span>` : ''}
                </td>
            </tr>`;
        });
        h += '</tbody></table>';
        document.getElementById('vinculos-container').innerHTML = h;
        document.getElementById('mod-cli').classList.add('is-active');
        lucide.createIcons();
    }

    function confirmDeleteAliado() {
        const id = document.getElementById('ed-cli-id').value;
        const nombre = document.getElementById('ed-cli-nom').value;
        openConfirm(`¿ESTÁ SEGURO DE ELIMINAR EL ALIADO "${nombre.toUpperCase()}"?`, async () => {
            await apiCall('deleteCliente', { id_cliente: id });
            closeModals(); refresh();
        });
    }

    function confirmDeleteVinculo(idCli, idFin) {
        openConfirm("¿Desea eliminar la vinculación de este factor?", async () => {
            await apiCall('deletePorcentaje', { id_cliente: idCli, id_financiera: idFin });
            openAliado(idCli); 
        });
    }

    async function saveAliado() {
        const id = document.getElementById('ed-cli-id').value;
        await apiCall('updateCliente', { id_cliente: id, nombre_cliente: document.getElementById('ed-cli-nom').value, contrasena: document.getElementById('ed-cli-pass').value });
        const inps = document.querySelectorAll('.v-fac');
        for(let i of inps) { if(i.value!=="") await apiCall('updatePorcentaje', { id_cliente: id, id_financiera: i.dataset.fin, factor_cliente: i.value }); }
        closeModals(); refresh();
    }

    function openFinanciera(id) {
        const f = db.financieras.find(x => String(x.id_financiera) === String(id));
        if(!f) return;
        document.getElementById('ed-fin-id').value = f.id_financiera;
        document.getElementById('ed-fin-nom').value = f.nombre_financiera;
        document.getElementById('ed-fin-fac').value = f.factor_financiera;
        let h = '<table class="table is-fullwidth is-narrow is-bordered"><thead><tr><th>Plan</th><th>% Int</th><th>% Fia</th><th class="has-text-centered">Acción</th></tr></thead><tbody>';
        db.cuotas.filter(c => String(c.id_financiera) === String(id)).forEach(c => {
            h += `<tr>
                <td class="is-size-7">${c.tipo_cuota.toUpperCase()} (${c.numero_cuotas})</td>
                <td><input class="input is-small p-int" data-id="${c.id_cuota}" type="number" step="0.0001" value="${c.tasa_interes}"></td>
                <td><input class="input is-small p-fia" data-id="${c.id_cuota}" type="number" step="0.0001" value="${c.tasa_fianza}"></td>
                <td class="has-text-centered">
                    <span class="btn-delete-row" onclick="event.stopPropagation(); confirmDeletePlan('${c.id_cuota}', '${id}')" title="Eliminar Plan">
                        <i data-lucide="trash-2" style="width:16px;"></i>
                    </span>
                </td>
            </tr>`;
        });
        h += '</tbody></table>';
        document.getElementById('planes-container').innerHTML = h;
        document.getElementById('mod-fin').classList.add('is-active');
        lucide.createIcons();
    }

    function confirmDeleteFinanciera() {
        const id = document.getElementById('ed-fin-id').value;
        const nombre = document.getElementById('ed-fin-nom').value;
        openConfirm(`¿ESTÁ SEGURO DE ELIMINAR LA ENTIDAD "${nombre.toUpperCase()}"?`, async () => {
            await apiCall('deleteFinanciera', { id_financiera: id });
            closeModals(); refresh();
        });
    }

    function confirmDeletePlan(idCuota, idFin) {
        openConfirm("¿Está seguro de eliminar este plan de cuotas?", async () => {
            await apiCall('deletePlanCuota', { id_cuota: idCuota });
            openFinanciera(idFin); 
        });
    }

    async function saveFinanciera() {
        const id = document.getElementById('ed-fin-id').value;
        await apiCall('updateFinanciera', { id_financiera: id, nombre_financiera: document.getElementById('ed-fin-nom').value, factor_financiera: document.getElementById('ed-fin-fac').value });
        const ints = document.querySelectorAll('.p-int'); const fias = document.querySelectorAll('.p-fia');
        for(let i=0; i<ints.length; i++) { await apiCall('updatePlanCuota', { id_cuota: ints[i].dataset.id, tasa_interes: ints[i].value, tasa_fianza: fias[i].value }); }
        closeModals(); refresh();
    }

    function closeModals() { 
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('is-active')); 
    }

    // --- LOGICA DE HISTORIAL ---

    function parseDateString(dateStr) {
        if (!dateStr) return new Date();
        if (typeof dateStr === 'string' && dateStr.includes('/')) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
        }
        return new Date(dateStr);
    }

    function filterSimulations() {
      const d = document.getElementById('f-desde').value; 
      const h = document.getElementById('f-hasta').value;
      let list = db.simulaciones || [];
      
      const t1 = d ? new Date(d + 'T00:00:00').getTime() : null;
      const t2 = h ? new Date(h + 'T23:59:59').getTime() : null;

      const getVal = (obj, keys) => {
        for(let k of keys) {
          const found = Object.keys(obj).find(x => x.toLowerCase().trim() === k.toLowerCase());
          if(found) return obj[found];
        }
        return "";
      };

      if(t1 && t2) {
        list = list.filter(s => { 
          const rawDate = getVal(s, ['fecha', 'fecha_registro', 'Fecha']);
          const t = parseDateString(rawDate).getTime(); 
          return t >= t1 && t <= t2; 
        });
      }
      
      const fmt = v => Number(v || 0).toLocaleString('es-CO', {style:'currency', currency:'COP', maximumFractionDigits:0});
      
      let sumCreditos = 0;
      let sumUtilidad = 0;

      const html = list.length ? list.slice().reverse().map(s => {
        const tienda = db.clientes.find(c => String(c.id_cliente) === String(getVal(s, ['id_cliente', 'aliado'])))?.nombre_cliente || 'Aliado';
        const entidad = db.financieras.find(f => String(f.id_financiera) === String(getVal(s, ['id_financiera', 'entidad'])))?.nombre_financiera || 'Entidad';
        
        const totalCredito = Number(getVal(s, ['valor_a_consignar', 'total_credito']) || 0);
        const utilidad = Number(getVal(s, ['utilidad', 'ganancia']) || 0);
        const cuota = Number(getVal(s, ['valor_cuota', 'cuota']) || 0);
        const plazo = getVal(s, ['n_cuotas', 'cuotas', 'plazo']);
        const totalFin = Number(getVal(s, ['total_financiado', 'total_pagado']) || 0);

        sumCreditos += totalCredito;
        sumUtilidad += utilidad;

        const rawDateStr = getVal(s, ['fecha', 'fecha_registro', 'Fecha']);
        const displayDate = typeof rawDateStr === 'string' && rawDateStr.includes('/') ? rawDateStr : new Date(rawDateStr).toLocaleDateString('es-CO');

        return `<tr>
          <td class="is-size-7">${displayDate}</td>
          <td class="has-text-weight-bold" style="color: var(--gets-purple);">${tienda}</td>
          <td class="has-text-weight-semibold">${entidad}</td>
          <td>${getVal(s, ['cc', 'documento'])}</td>
          <td>${getVal(s, ['nombre', 'solicitante'])}</td>
          <td>${getVal(s, ['correo', 'email'])}</td>
          <td>${getVal(s, ['celular', 'telefono'])}</td>
          <td class="has-text-right has-text-weight-bold">${fmt(totalCredito)}</td>
          <td class="has-text-right" style="color: #059669;">${fmt(utilidad)}</td>
          <td class="has-text-right">${fmt(cuota)}</td>
          <td class="has-text-centered">${plazo}</td>
          <td class="has-text-right has-text-weight-bold" style="color: var(--gets-purple);">${fmt(totalFin)}</td>
        </tr>`;
      }).join('') : '<tr><td colspan="12" class="has-text-centered py-4">No se hallaron registros en el rango seleccionado</td></tr>';
      
      document.getElementById('tb-simulaciones').innerHTML = html;
      document.getElementById('total-count').innerText = list.length;
      document.getElementById('total-creditos').innerText = fmt(sumCreditos);
      document.getElementById('total-utilidad').innerText = fmt(sumUtilidad);
      lucide.createIcons();
    }

    // --- COMUNICACION API ---

    async function fetchApi(action, data = null) {
      const url = new URL(SCRIPT_URL);
      url.searchParams.append('action', action);
      if(data) url.searchParams.append('data', JSON.stringify(data));
      try {
        const res = await fetch(url.toString(), { method: 'GET', mode: 'cors' });
        const json = await res.json();
        if (json.status === 'error') throw new Error(json.message);
        return json.data;
      } catch (e) { 
        showToast("Error: " + e.message, 'error'); 
        return null; 
      }
    }

    async function apiCall(action, data = null) {
      const res = await fetchApi(action, data);
      if(res) { 
        if(action==='guardarSimulacion') {
            clearInputs();
            showToast("Simulación Registrada Correctamente");
        } else {
            showToast(res);
        }
        refresh(); 
      }
    }

    // --- UTILIDADES ---

    function switchView(v) {
      document.querySelectorAll('.section-view').forEach(e => e.classList.remove('is-active-view'));
      document.querySelectorAll('.tab-item').forEach(e => e.classList.remove('is-active'));
      document.getElementById('v-' + v).classList.add('is-active-view');
      document.getElementById('t-' + v).classList.add('is-active');
      document.getElementById('app-container').classList.toggle('wide', v === 'con');
    }

    function switchQuery(sec) {
      document.querySelectorAll('.q-section').forEach(s => s.style.display = 'none');
      document.querySelectorAll('.query-sidebar a').forEach(a => a.classList.remove('is-active'));
      document.getElementById('q-' + sec).style.display = 'block';
      document.getElementById('m-' + sec).classList.add('is-active');
    }

    function fill(id, list, v, t, hasPlaceholder = false) {
      const el = document.getElementById(id); if(!el) return;
      let opts = hasPlaceholder ? '<option value="placeholder" selected disabled>Seleccione...</option>' : '';
      el.innerHTML = list.length ? opts + list.map(i => `<option value="${i[v]}">${i[t]}</option>`).join('') : '<option value="">(Vacío)</option>';
    }

    function loadAssignedEntities(clientId) {
      const assignedIds = db.porcentajes.filter(p => String(p.id_cliente) === String(clientId)).map(p => String(p.id_financiera));
      fill('sel_financiera', db.financieras.filter(f => assignedIds.includes(String(f.id_financiera))), 'id_financiera', 'nombre_financiera', true);
    }

    function handleAllyChange() { loadAssignedEntities(document.getElementById('sel_cliente').value); }

    function loadPlanes() {
      const idFin = document.getElementById('sel_financiera').value;
      fill('sel_plan', db.cuotas.filter(c => String(c.id_financiera) === String(idFin)).map(c => ({id: c.id_cuota, text: c.tipo_cuota.toUpperCase() + ' ('+c.numero_cuotas+')'})), 'id', 'text', true);
    }

    function loadNumCuotas() {
      const idCuo = document.getElementById('sel_plan').value;
      const plan = db.cuotas.find(c => String(c.id_cuota) === String(idCuo));
      if(plan) {
        let o = '<option value="" selected disabled>...</option>';
        for(let i=1; i <= plan.numero_cuotas; i++) o += `<option value="${i}">${i} cuota${i>1?'s':''}</option>`;
        document.getElementById('sel_n_cuotas').innerHTML = o;
      }
      calc();
    }

    function calc() {
      const idCli = document.getElementById('sel_cliente').value;
      const idFin = document.getElementById('sel_financiera').value;
      const idCuo = document.getElementById('sel_plan').value;
      const nElegido = parseInt(document.getElementById('sel_n_cuotas').value) || 0;
      const precio = parseFloat(document.getElementById('in_precio').value) || 0;
      if (!idCli || idCli === "placeholder" || !idFin || idFin === "placeholder") return null;
      const fin = db.financieras.find(f => String(f.id_financiera) === String(idFin));
      const rel = db.porcentajes.find(p => String(p.id_cliente) === String(idCli) && String(p.id_financiera) === String(idFin));
      const cuo = db.cuotas.find(c => String(c.id_cuota) === String(idCuo));
      if(!fin || !rel || !cuo || precio <= 0 || nElegido <= 0) { render(0,0); return null; }
      const cons = precio / rel.factor_cliente;
      const tasaInt = parseFloat(cuo.tasa_interes) || 0;
      const cuotaBase = (cons + (cons * tasaInt * nElegido)) / nElegido;
      const v_cuo = cuotaBase + (cuotaBase * (parseFloat(cuo.tasa_fianza) || 0));
      render(cons, v_cuo);
      return { id_cliente: idCli, id_financiera: idFin, id_cuota: idCuo, precio_producto: precio, valor_a_consignar: cons, utilidad: (precio / rel.factor_cliente) - (precio / fin.factor_financiera), valor_cuota: v_cuo, total_financiado: v_cuo * nElegido, n_cuotas: nElegido };
    }

    function render(c, q) {
      const f = v => v.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
      document.getElementById('out_consignar').innerText = f(c);
      document.getElementById('out_cuota').innerText = f(q);
    }

    function validateAndSave() {
      const checks = ['in_cc', 'in_celular', 'in_nombre_sol', 'in_correo', 'sel_financiera', 'sel_plan', 'sel_n_cuotas', 'in_precio'];
      for (let id of checks) { const el = document.getElementById(id); if (!el.value || el.value === "placeholder") { showToast("Complete todos los campos requeridos.", 'error'); el.focus(); return; } }
      apiCall('guardarSimulacion', { ...calc(), cc: document.getElementById('in_cc').value, nombre: document.getElementById('in_nombre_sol').value, correo: document.getElementById('in_correo').value, celular: document.getElementById('in_celular').value });
    }

    function clearInputs() { 
      ['in_cc', 'in_celular', 'in_nombre_sol', 'in_correo', 'in_precio'].forEach(id => document.getElementById(id).value = ""); 
      document.getElementById('out_consignar').innerText = "$ 0"; 
      document.getElementById('out_cuota').innerText = "$ 0"; 
    }
  </script>
</body>
</html>
