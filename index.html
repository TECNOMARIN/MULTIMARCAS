<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gets Solutions | Gestión Integral</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #6d28d9 0%, #3b82f6 100%);
      --gets-purple: #9333ea;
      --gets-dark: #1e293b;
    }
    body { background: var(--primary-gradient); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; font-family: sans-serif; }
    .main-card { width: 100%; max-width: 650px; background: white; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); overflow: hidden; }
    .brand-header { padding: 1.5rem; text-align: center; }
    .brand-logo { max-width: 140px; }
    .custom-tabs { display: flex; border-bottom: 1px solid #f1f5f9; }
    .tab-item { flex: 1; padding: 1rem; text-align: center; cursor: pointer; color: #94a3b8; font-weight: 600; font-size: 0.8rem; }
    .tab-item.is-active { color: var(--gets-purple); border-bottom: 3px solid var(--gets-purple); }
    .section-view { display: none; padding: 1.5rem; }
    .is-active-view { display: block; }
    .box-admin { border: 1px solid #f1f5f9; padding: 1.25rem; border-radius: 10px; margin-bottom: 1.5rem; background: #fafafa; }
    .res-grid { background: #f8fafc; border-radius: 12px; padding: 1rem; margin-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
    .res-item p:first-child { font-size: 0.6rem; color: #64748b; font-weight: 700; text-transform: uppercase; }
    .res-item p:last-child { font-size: 1rem; color: var(--gets-dark); font-weight: 800; }
    .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .error-msg { font-size: 0.75rem; color: #e11d48; margin-top: 0.5rem; display: none; }
    .admin-label { font-size: 0.7rem; font-weight: 700; color: var(--gets-purple); text-transform: uppercase; margin-bottom: 0.5rem; display: block; }
  </style>
</head>
<body>

  <div id="loading" class="loader-overlay">
    <div class="button is-loading is-large is-white"></div>
    <p class="mt-4 has-text-grey" id="loader_text">Sincronizando con el servidor central...</p>
    <div id="connection_error" class="error-msg px-4 has-text-centered">
      <b>Error de conexión:</b> No se pudo establecer comunicación con el servidor. <br>
      Por favor, verifique la configuración de acceso del sistema.
    </div>
  </div>

  <div class="main-card">
    <div class="brand-header">
      <img src="https://appgets.solutions/img/logoempresa.png" alt="Logo" class="brand-logo">
    </div>

    <div class="custom-tabs">
      <div id="t-sim" class="tab-item is-active" onclick="switchView('sim')">Calculadora</div>
      <div id="t-adm" class="tab-item" onclick="switchView('adm')">Configuración</div>
    </div>

    <!-- CALCULADORA -->
    <div id="v-sim" class="section-view is-active-view">
      <div class="field">
        <label class="label is-small">Aliado / Cliente</label>
        <div class="select is-fullwidth"><select id="sel_cliente" onchange="calc()"></select></div>
      </div>
      <div class="columns is-mobile mb-0">
        <div class="column">
          <label class="label is-small">Entidad</label>
          <div class="select is-fullwidth"><select id="sel_financiera" onchange="loadCuotas()"></select></div>
        </div>
        <div class="column">
          <label class="label is-small">Plan / Plazo</label>
          <div class="select is-fullwidth"><select id="sel_cuota" onchange="calc()"></select></div>
        </div>
      </div>
      <div class="field">
        <label class="label is-small">Precio del Producto ($)</label>
        <input id="in_precio" class="input" type="number" placeholder="0.00" oninput="calc()">
      </div>
      
      <div class="res-grid">
        <div class="res-item"><p>A Consignar</p><p id="out_consignar">$ 0</p></div>
        <div class="res-item"><p>Utilidad</p><p id="out_utilidad" style="color: #059669;">$ 0</p></div>
        <div class="res-item"><p>Valor Cuota</p><p id="out_cuota" style="color: var(--gets-purple);">$ 0</p></div>
        <div class="res-item"><p>Total</p><p id="out_total">$ 0</p></div>
      </div>
      <button id="btn_save" class="button is-purple is-fullwidth mt-4" style="background: var(--gets-purple); color:white" onclick="apiCall('guardarSimulacion')">
        Registrar Simulación
      </button>
    </div>

    <!-- CONFIGURACIÓN -->
    <div id="v-adm" class="section-view">
      
      <!-- 1. ALIADOS -->
      <div class="box-admin">
        <span class="admin-label">1. Registro de Aliados</span>
        <div class="field has-addons">
          <div class="control is-expanded"><input id="new_cli_nom" class="input is-small" placeholder="Nombre del Aliado"></div>
          <div class="control"><button class="button is-purple is-small" onclick="apiCall('crearCliente')">Registrar</button></div>
        </div>
      </div>

      <!-- 2. ENTIDADES -->
      <div class="box-admin">
        <span class="admin-label">2. Registro de Entidades</span>
        <div class="columns is-mobile mb-2">
          <div class="column is-8"><input id="new_fin_nom" class="input is-small" placeholder="Nombre de Entidad"></div>
          <div class="column is-4"><input id="new_fin_fac" class="input is-small" type="number" step="0.01" placeholder="Factor Base"></div>
        </div>
        <button class="button is-info is-fullwidth is-small" onclick="apiCall('crearFinanciera')">Guardar Entidad</button>
      </div>

      <!-- 3. PLANES DE CUOTAS -->
      <div class="box-admin">
        <span class="admin-label">3. Definición de Planes (Tasas Mensuales)</span>
        <div class="field">
          <div class="select is-fullwidth is-small mb-2">
            <select id="plan_fin_id"></select>
          </div>
        </div>
        <div class="columns is-mobile mb-2">
          <div class="column">
            <div class="select is-fullwidth is-small">
              <select id="plan_tipo">
                <option value="mensual">Mensual</option>
                <option value="quincenal">Quincenal</option>
              </select>
            </div>
          </div>
          <div class="column">
            <input id="plan_num" class="input is-small" type="number" placeholder="Cuotas Máx.">
          </div>
        </div>
        <div class="columns is-mobile mb-2">
          <div class="column">
            <input id="plan_int" class="input is-small" type="number" step="0.01" placeholder="% Int. Mensual">
          </div>
          <div class="column">
            <input id="plan_fia" class="input is-small" type="number" step="0.01" placeholder="% Fianza Mensual">
          </div>
        </div>
        <button class="button is-dark is-fullwidth is-small" onclick="apiCall('crearPlanCuota')">Registrar Plan</button>
      </div>

      <!-- 4. VINCULACIÓN (PORCENTAJES) -->
      <div class="box-admin">
        <span class="admin-label">4. Vinculación y Factores Específicos</span>
        <div class="columns is-mobile mb-2">
          <div class="column"><div class="select is-fullwidth is-small"><select id="rel_cli_id"></select></div></div>
          <div class="column"><div class="select is-fullwidth is-small"><select id="rel_fin_id"></select></div></div>
        </div>
        <div class="field">
          <input id="rel_fac_val" class="input is-small" type="number" step="0.01" placeholder="Factor Asignado al Aliado">
        </div>
        <button class="button is-warning is-fullwidth is-small" onclick="apiCall('asignarFactorCliente')">Vincular Aliado</button>
      </div>

      <div class="box-admin">
        <p class="is-size-7 has-text-grey mb-2">Actualiza los datos locales con la información más reciente del servidor central.</p>
        <button class="button is-light is-fullwidth is-small" onclick="refresh()">Sincronizar Sistema</button>
      </div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzH2a6_gdBJ6uEzmms8qneHg5XnpThtWALqEjgZ9YYcEyMdG1ikYWb68POhtVELJdrdRA/exec";
    
    let db = { clientes: [], financieras: [], cuotas: [], porcentajes: [] };

    window.onload = () => { refresh(); };

    async function refresh() {
      document.getElementById('loading').style.display = 'flex';
      document.getElementById('connection_error').style.display = 'none';
      
      const res = await fetchApi('getData');
      if(res) {
        db = res;
        fill('sel_cliente', db.clientes, 'id_cliente', 'nombre_cliente');
        fill('sel_financiera', db.financieras, 'id_financiera', 'nombre_financiera');
        
        fill('plan_fin_id', db.financieras, 'id_financiera', 'nombre_financiera');
        fill('rel_cli_id', db.clientes, 'id_cliente', 'nombre_cliente');
        fill('rel_fin_id', db.financieras, 'id_financiera', 'nombre_financiera');

        loadCuotas();
        document.getElementById('loading').style.display = 'none';
      } else {
        document.getElementById('loader_text').innerText = "Fallo la sincronización.";
        document.getElementById('connection_error').style.display = 'block';
      }
    }

    async function fetchApi(action, params = {}) {
      const url = new URL(SCRIPT_URL);
      url.searchParams.append('action', action);
      for (const key in params) url.searchParams.append(key, params[key]);
      
      try {
        const response = await fetch(url.toString(), {
          method: 'GET',
          mode: 'cors',
          cache: 'no-cache'
        });

        if (!response.ok) throw new Error("Acceso Denegado");
        
        const json = await response.json();
        if(json.status === 'success') return json.data;
        
        alert("Error del Sistema: " + json.message);
        return null;
      } catch (e) {
        console.error("Communication Error:", e);
        return null;
      }
    }

    async function apiCall(action) {
      const btn = event.currentTarget;
      btn.classList.add('is-loading');

      let params = {};
      
      if(action === 'crearCliente') {
        params.nombre = document.getElementById('new_cli_nom').value;
      }
      else if(action === 'crearFinanciera') {
        params.nombre = document.getElementById('new_fin_nom').value;
        params.factor = document.getElementById('new_fin_fac').value;
      }
      else if(action === 'crearPlanCuota') {
        const data = {
          id_financiera: document.getElementById('plan_fin_id').value,
          tipo_cuota: document.getElementById('plan_tipo').value,
          numero_cuotas: document.getElementById('plan_num').value,
          tasa_interes: document.getElementById('plan_int').value,
          tasa_fianza: document.getElementById('plan_fia').value
        };
        params.data = JSON.stringify(data);
      }
      else if(action === 'asignarFactorCliente') {
        const data = {
          id_cliente: document.getElementById('rel_cli_id').value,
          id_financiera: document.getElementById('rel_fin_id').value,
          factor_cliente: document.getElementById('rel_fac_val').value
        };
        params.data = JSON.stringify(data);
      }
      else if(action === 'guardarSimulacion') {
        const data = calc();
        if(!data) { btn.classList.remove('is-loading'); return; }
        params.data = JSON.stringify(data);
      }

      const res = await fetchApi(action, params);
      btn.classList.remove('is-loading');
      
      if(res) { 
        alert(res); 
        refresh(); 
      }
    }

    function fill(id, list, v, t) {
      const el = document.getElementById(id);
      if(!el) return;
      el.innerHTML = (list && list.length) 
        ? list.map(i => `<option value="${i[v]}">${i[t]}</option>`) 
        : '<option value="">(Sin registros)</option>';
    }

    function switchView(v) {
      document.querySelectorAll('.section-view').forEach(e => e.classList.remove('is-active-view'));
      document.querySelectorAll('.tab-item').forEach(e => e.classList.remove('is-active'));
      document.getElementById('v-' + v).classList.add('is-active-view');
      document.getElementById('t-' + v).classList.add('is-active');
    }

    function loadCuotas() {
      const idFin = document.getElementById('sel_financiera').value;
      const filtered = db.cuotas.filter(c => String(c.id_financiera) === idFin);
      document.getElementById('sel_cuota').innerHTML = filtered.length 
        ? filtered.map(c => `<option value="${c.id_cuota}">${c.tipo_cuota.toUpperCase()} (${c.numero_cuotas} máx)</option>`) 
        : '<option value="">(Sin planes)</option>';
      calc();
    }

    function calc() {
      const idCli = document.getElementById('sel_cliente').value;
      const idFin = document.getElementById('sel_financiera').value;
      const idCuo = document.getElementById('sel_cuota').value;
      const precio = parseFloat(document.getElementById('in_precio').value) || 0;
      
      const fin = db.financieras.find(f => String(f.id_financiera) === idFin);
      const rel = db.porcentajes.find(p => String(p.id_cliente) === idCli && String(p.id_financiera) === idFin);
      const cuo = db.cuotas.find(c => String(c.id_cuota) === idCuo);

      if(!fin || !rel || precio <= 0) { 
        render(0,0,0,0); 
        return null; 
      }

      const cons = precio / rel.factor_cliente;
      const util = (precio / rel.factor_cliente) - (precio / fin.factor_financiera);
      
      let v_cuo = 0, v_tot = 0;
      if(cuo) {
        const n_max = parseInt(cuo.numero_cuotas) || 1;
        const t_mes = (parseFloat(cuo.tasa_interes) || 0) + (parseFloat(cuo.tasa_fianza) || 0);
        v_tot = precio * (1 + t_mes); 
        v_cuo = v_tot / n_max;
      }
      
      render(cons, util, v_cuo, v_tot);
      
      return { 
        id_cliente: idCli, 
        id_financiera: idFin, 
        id_cuota: idCuo, 
        precio_producto: precio, 
        valor_a_consignar: cons, 
        utilidad: util, 
        valor_cuota: v_cuo, 
        total_financiado: v_tot 
      };
    }

    function render(c, u, q, t) {
      const f = v => v.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
      document.getElementById('out_consignar').innerText = f(c);
      document.getElementById('out_utilidad').innerText = f(u);
      document.getElementById('out_cuota').innerText = f(q);
      document.getElementById('out_total').innerText = f(t);
    }
  </script>
</body>
</html>
