<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soluciones Efectivas CTG | Gesti√≥n empresarial V2.107</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* --- FUENTE CORPORATIVA --- */
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap');

    /* --- VARIABLES DE DISE√ëO --- */
    :root {
      --primary-gradient: linear-gradient(135deg, #1e3a6d 0%, #2C4C8C 100%);
      --brand-blue: #2C4C8C;
      --brand-green: #67B74D;
      --gets-dark: #1e293b;
      --gets-light: #f8fafc;
      --gets-red: #ef4444;
      --gets-blue: #2563eb;
      --soft-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
      
      --color-brilla: #e30613;
      --color-sumas: #e1005d;
      --color-bogota: #003e9a;
      --color-addi: #001aff;
      --color-siste: #059669;
      --color-vanti: #00b5cb;
    }
    
    body { 
      background: var(--primary-gradient); 
      min-height: 100vh; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      padding: 1rem; 
      margin: 0; 
      font-family: 'Montserrat', sans-serif;
      -webkit-font-smoothing: antialiased; 
    }
    
    .main-card { width: 100%; max-width: 500px; background: white; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.35); overflow: hidden; display: none; transition: max-width 0.4s ease; position: relative; }
    .main-card.wide { max-width: 1150px; } 

    /* CAPAS Z-INDEX */
    .modal { z-index: 5000; }
    #mod-confirm { z-index: 6000; }
    #toast-container { z-index: 100000; }
    #bg-sync-indicator { z-index: 4000; }

    /* TOASTS */
    #toast-container { position: fixed; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 12px; pointer-events: none; }
    .toast { background: white; border-radius: 16px; padding: 14px 20px; box-shadow: 0 15px 30px -5px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 15px; transform: translateX(120%); transition: 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); pointer-events: auto; border-left: 6px solid var(--brand-blue); min-width: 280px; }
    .toast.is-active { transform: translateX(0); }
    .toast.is-success { border-left-color: var(--brand-green); }
    .toast.is-error { border-left-color: var(--gets-red); }
    .toast-content { color: var(--gets-dark); font-size: 0.85rem; font-weight: 700; }

    #bg-sync-indicator { position: absolute; top: 10px; right: 20px; font-size: 0.65rem; color: var(--brand-blue); font-weight: 700; display: none; align-items: center; gap: 5px; background: rgba(255,255,255,0.95); padding: 5px 12px; border-radius: 20px; box-shadow: var(--soft-shadow); }

    /* CABECERA Y LOGO */
    .brand-header { padding: 0.5rem 1.5rem; text-align: center; border-bottom: 1px solid #f1f5f9; background: white; overflow: hidden; min-height: 120px; display: flex; align-items: center; justify-content: space-between; position: relative; }
    .brand-logo { max-height: 130px; width: auto; transform: scale(1.1); display: block; margin: 0 auto; transition: 0.3s; object-fit: contain; }
    .header-left-logo { margin: 0 !important; transform-origin: left center; transform: scale(1.1) !important; max-height: 120px !important; }

    #login-container .brand-header { height: auto; min-height: 380px; padding-top: 4rem; padding-bottom: 1.5rem; border-bottom: none; display: flex; align-items: center; justify-content: center; }
    #login-container .brand-logo { max-height: 320px; transform: scale(1.1); transform-origin: center; margin-bottom: 1rem; }

    .custom-tabs { display: flex; background: #fafafa; border-bottom: 1px solid #f1f5f9; overflow-x: auto; }
    .tab-item { flex: 1; min-width: 120px; padding: 1.1rem 0.5rem; text-align: center; cursor: pointer; color: #94a3b8; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; border-bottom: 3px solid transparent; transition: 0.3s; white-space: nowrap; }
    .tab-item.is-active { color: var(--brand-blue); border-bottom-color: var(--brand-blue); background: white; }

    .section-view { display: none !important; padding: 1.75rem; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .section-view.is-active-view { display: block !important; }

    /* PESTA√ëAS HORIZONTALES */
    .query-tabs { display: flex; gap: 10px; padding: 1rem 1.5rem; background: #f8fafc; border-bottom: 1px solid #f1f5f9; overflow-x: auto; }
    .query-tab-item { padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.8rem; font-weight: 700; color: #64748b; cursor: pointer; transition: 0.4s ease; white-space: nowrap; border: 1px solid transparent; }
    .query-tab-item.is-active { background: white; color: var(--brand-blue); border-color: #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

    .admin-sec { display: none; }
    .admin-sec.is-active { display: block; }
    .admin-label { font-size: 0.75rem; font-weight: 900; color: var(--brand-blue); text-transform: uppercase; margin-bottom: 1rem; display: block; letter-spacing: 0.05em; }
    .box-admin { border: 1px solid #f1f5f9; padding: 1.75rem; border-radius: 20px; margin-bottom: 1.5rem; background: #fcfdfe; }

    /* CALCULADORA */
    .welcome-banner { background: #fdfcff; border-radius: 16px; padding: 1.25rem; margin-bottom: 2rem; border: 1px solid #eee; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); }
    .welcome-icon { background: var(--brand-blue); color: white; width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(44, 76, 140, 0.25); }
    
    .res-grid { background: #1e293b; border-radius: 20px; padding: 1.5rem; margin: 1.5rem 0; color: white; text-align: center; display: flex; gap: 15px; }
    .res-item { flex: 1; }
    .res-item p:first-child { font-size: 0.65rem; color: #94a3b8; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; }
    .res-item p:last-child { font-size: 1.3rem; font-weight: 900; }

    /* FILTROS HISTORIAL */
    .filter-panel-history { background: #f8fafc; padding: 1.25rem; border-radius: 20px; border: 1px solid #e2e8f0; margin-bottom: 1.5rem; }
    .select.is-period-select-large select { font-size: 1.1rem !important; font-weight: 800; height: 48px; border-radius: 12px; color: var(--brand-blue) !important; border: 2px solid var(--brand-blue) !important; }
    .select.is-period-select-large select option { font-size: 1.15rem !important; font-weight: 600; padding: 10px; }

    /* CR√âDITO EN L√çNEA */
    .ext-card { height: 100%; border: 1px solid #f1f5f9; border-radius: 24px; padding: 2rem 1.5rem; text-align: center; display: flex; flex-direction: column; transition: 0.3s; background: #fff; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); position: relative; overflow: hidden; }
    .ext-card::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: var(--brand-blue); }
    .ext-card.brilla::after { background: var(--color-brilla); }
    .ext-card.sumas::after { background: var(--color-sumas); }
    .ext-card.bogota::after { background: var(--color-bogota); }
    .ext-card.addi::after { background: var(--color-addi); }
    .ext-card.siste::after { background: var(--color-siste); }
    .ext-card.vanti::after { background: var(--color-vanti); }

    .ext-card h3 { font-size: 1.1rem; font-weight: 900; margin-bottom: 0.75rem; color: var(--gets-dark); text-transform: uppercase; }
    .ext-card p { font-size: 0.8rem; color: #64748b; margin-bottom: 1.5rem; flex-grow: 1; line-height: 1.4; }
    .btn-ext { border-radius: 12px; font-weight: 800; width: 100%; height: 50px; border: none; cursor: pointer; color: white !important; display: flex; align-items: center; justify-content: center; gap: 10px; text-decoration: none !important; transition: 0.3s; box-shadow: 0 8px 15px -3px rgba(0,0,0,0.1); }
    .btn-ext:hover { transform: translateY(-2px); filter: brightness(1.1); color: white; }

    .btn-brilla { background: var(--color-brilla); }
    .btn-sumas { background: var(--color-sumas); }
    .btn-bogota { background: var(--color-bogota); }
    .btn-addi { background: var(--color-addi); }
    .btn-siste { background: var(--color-siste); }
    .btn-vanti { background: var(--color-vanti); }

    /* BOTONES PREMIUM */
    .btn-modern { border-radius: 14px; font-weight: 800; transition: all 0.3s; padding: 0.8rem 1.5rem; height: auto; font-size: 0.9rem; border: none; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; }
    .btn-modern.is-save { background: var(--primary-gradient); color: white; box-shadow: 0 10px 20px -5px rgba(44, 76, 140, 0.35); }
    .btn-modern.is-save:hover { transform: translateY(-3px); color: white; }

    .table-container { border-radius: 12px; border: 1px solid #f1f5f9; max-height: 500px; overflow: auto; background: white; }
    .table { font-size: 0.75rem; width: 100%; }
    .table thead th { position: sticky; top: 0; background: #fcfcfd; z-index: 5; font-weight: 900; }

    .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 1.5rem; }
    .kpi-card { background: white; border-radius: 18px; padding: 1.25rem; border: 1px solid #f1f5f9; box-shadow: var(--soft-shadow); text-align: center; }
    .kpi-card p:last-child { font-size: 1.1rem; font-weight: 900; color: var(--gets-dark); }

    .footer-v { text-align: center; padding: 1.5rem; font-size: 0.7rem; color: #94a3b8; background: #fcfcfd; border-top: 1px solid #f1f5f9; font-weight: 700; }

    .btn-delete-row { color: var(--gets-red); cursor: pointer; padding: 5px; transition: 0.2s; }
    .btn-delete-row:hover { transform: scale(1.2); }

    #brilla-fields { display: none; }

    @media screen and (max-width: 768px) {
      .kpi-grid { grid-template-columns: 1fr; }
      #login-container .brand-header { min-height: 250px; }
      #login-container .brand-logo { max-height: 220px; }
      .brand-header { flex-direction: column; gap: 15px; height: auto; padding: 1.5rem; }
      .header-left-logo { max-height: 90px !important; transform: scale(1) !important; }
    }
  </style>
</head>
<body>

  <div id="toast-container"></div>

  <!-- LOGIN -->
  <div id="login-container" class="main-card" style="display: block;">
    <div class="brand-header"><img src="https://github.com/TECNOMARIN/MULTIMARCAS/blob/main/SOLUCIONES%20PNG.png?raw=true" alt="Soluciones Efectivas CTG" class="brand-logo"></div>
    <div id="login-view" style="padding: 1.5rem 2rem 2.5rem 2rem;">
      <div style="text-align: center; margin-bottom: 2.5rem;">
        <div style="color: var(--brand-blue); background: #eff4fa; width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;"><i data-lucide="shield-check" style="width:32px; height:32px;"></i></div>
        <h2 class="title is-3 mb-4" style="font-weight:900; color: var(--gets-dark); letter-spacing: -0.02em;">Acceso Seguro</h2>
        <p class="subtitle is-6 has-text-grey-dark" style="margin-top: 0.5rem; font-weight: 500;">Gesti√≥n integral de cr√©ditos para aliados</p>
      </div>
      <div class="field"><label class="label is-small" style="font-weight: 700;">Aliado / Tienda</label><div class="control has-icons-left"><input id="login-user" class="input is-medium" type="text" placeholder="Nombre Comercial" style="border-radius:12px; font-weight: 600;"><span class="icon is-small is-left"><i data-lucide="store"></i></span></div></div>
      <div class="field mt-4"><label class="label is-small" style="font-weight: 700;">Contrase√±a</label><div class="control has-icons-left"><input id="login-pass" class="input is-medium" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="border-radius:12px; font-weight: 600;" onkeypress="if(event.key==='Enter') attemptLogin()"><span class="icon is-small is-left"><i data-lucide="key"></i></span></div></div>
      <button id="btn-login" class="button btn-modern is-save is-fullwidth is-medium mt-6" onclick="attemptLogin()">Ingresar al Portal</button>
    </div>
    <div class="footer-v">Soluciones Efectivas CTG | Gesti√≥n empresarial V2.107</div>
  </div>

  <!-- APP PRINCIPAL -->
  <div id="app-container" class="main-card">
    <div id="bg-sync-indicator"><div class="button is-loading is-small is-white" style="height:15px; width:15px; margin-right:5px;"></div> Sincronizando datos...</div>
    
    <div class="brand-header">
        <img src="https://github.com/TECNOMARIN/MULTIMARCAS/blob/main/SOLUCIONES%20PNG.png?raw=true" alt="Soluciones Efectivas CTG" class="brand-logo header-left-logo">
        <div style="display: flex; align-items: center; gap: 8px;">
            <a href="retailb.html" class="button is-small" style="font-weight:900; background-color: var(--brand-green); color: white; border: none; border-radius: 8px;">
                <i data-lucide="external-link" style="width:14px; margin-right:5px;"></i>Retail
            </a>
            <button class="button is-ghost is-small has-text-danger" onclick="location.reload()" style="font-weight:800;"><i data-lucide="log-out" style="width:14px; margin-right:5px;"></i>Salir</button>
        </div>
    </div>

    <div class="custom-tabs">
      <div id="t-sim" class="tab-item is-active" onclick="switchView('sim')">Calculadora</div>
      <div id="t-ext" class="tab-item" onclick="switchView('ext')">Cr√©dito en L√≠nea</div>
      <div id="t-adm" class="tab-item" onclick="switchView('adm')">Configuraci√≥n</div>
      <div id="t-con" class="tab-item" onclick="switchView('con')">Consultas</div>
    </div>

    <!-- CALCULADORA -->
    <div id="v-sim" class="section-view is-active-view">
      <div class="welcome-banner">
        <div class="welcome-icon"><i data-lucide="store"></i></div>
        <div class="welcome-text"><p style="font-weight: 600;">¬°Bienvenido de nuevo!</p><p id="display-store-name" style="color:var(--brand-blue); font-weight:900;">Cargando...</p></div>
      </div>
      <div class="field"><label class="label is-small" style="font-weight: 700;">Tienda / Aliado</label><div class="select is-fullwidth"><select id="sel_cliente" onchange="handleAllyChange()" style="font-weight: 600;"></select></div></div>
      <div class="field"><label class="label is-small" style="font-weight: 700;">Entidad Financiera</label><div class="select is-fullwidth"><select id="sel_financiera" onchange="loadPlanes()" style="font-weight: 600;"></select></div></div>
      <div class="columns is-mobile mb-0"><div class="column"><label class="label is-small" style="font-weight: 700;">Plan Elegido</label><div class="select is-fullwidth"><select id="sel_plan" onchange="loadNumCuotas()" style="font-weight: 600;"></select></div></div><div class="column"><label class="label is-small" style="font-weight: 700;">Cuotas</label><div class="select is-fullwidth"><select id="sel_n_cuotas" onchange="calc()" style="font-weight: 600;"></select></div></div></div>
      <div class="field"><label class="label is-small" style="font-weight: 700;">Precio del Producto ($)</label><input id="in_precio" class="input is-medium" style="font-weight: 900;" type="text" placeholder="$ 0" oninput="handlePriceInput(this)"></div>
      <div class="res-grid"><div class="res-item"><p>Total Cr√©dito</p><p id="out_consignar">$ 0</p></div><div class="res-item"><p>Cuota (Aprox.)</p><p id="out_cuota">$ 0</p></div></div>
      
      <div class="solicitante-section" style="border-left: 4px solid var(--brand-blue); padding: 0.75rem 1.25rem; margin-top: 1.5rem; margin-bottom: 2rem; background: #fafafa; border-radius: 0 16px 16px 0;">
        <span class="admin-label" style="margin-bottom: 1rem;">Datos del Solicitante (Cliente)</span>
        <div class="columns is-mobile is-multiline mb-0">
            <div class="column is-6 py-1"><input id="in_cc" class="input is-small" style="font-weight: 600;" placeholder="CC / Documento"></div>
            <div class="column is-6 py-1"><input id="in_celular" class="input is-small" style="font-weight: 600;" placeholder="Celular"></div>
            <div class="column is-12 py-1"><input id="in_nombre_sol" class="input is-small" style="font-weight: 600;" placeholder="Nombre completo"></div>
            <div class="column is-12 py-1"><input id="in_correo" class="input is-small" style="font-weight: 600;" placeholder="Correo electr√≥nico"></div>
            <div id="brilla-fields" class="column is-12 p-0">
                <div class="columns is-multiline is-mobile m-0">
                    <div class="column is-12 py-1"><input id="in_direccion" class="input is-small" style="font-weight: 600;" placeholder="Direcci√≥n"></div>
                    <div class="column is-12 py-1"><input id="in_articulo" class="input is-small" style="font-weight: 600;" placeholder="Art√≠culo espec√≠fico"></div>
                    <div class="column is-6 py-1"><input id="in_ref1_nom" class="input is-small" style="font-weight: 600;" placeholder="Nombre Ref 1"></div>
                    <div class="column is-6 py-1"><input id="in_ref1_tel" class="input is-small" style="font-weight: 600;" placeholder="Tel√©fono Ref 1"></div>
                    <div class="column is-6 py-1"><input id="in_ref2_nom" class="input is-small" style="font-weight: 600;" placeholder="Nombre Ref 2"></div>
                    <div class="column is-6 py-1"><input id="in_ref2_tel" class="input is-small" style="font-weight: 600;" placeholder="Tel√©fono Ref 2"></div>
                </div>
            </div>
        </div>
      </div>
      <button id="btn-main-action" class="button btn-modern is-save is-fullwidth is-medium" onclick="validateAndSave()">Enviar y Registrar</button>
    </div>

    <!-- CR√âDITO EN L√çNEA -->
    <div id="v-ext" class="section-view">
        <div class="columns is-multiline">
            <div class="column is-6-tablet is-4-desktop"><div class="ext-card brilla"><h3>Cupo Brilla</h3><p>Usa tu Cupo Brilla Surtigas para tecnolog√≠a y hogar.<br><br><span style="font-size: 0.75rem; opacity: 0.9;"><strong>Requisitos:</strong> Solo necesitas estar al d√≠a en tu factura del gas, los dos √∫ltimos recibos y tu c√©dula de ciudadan√≠a.</span></p><button class="btn-ext btn-brilla" onclick="sendAssessorWhatsApp('Brilla Surtigas')">üè† Contacta un asesor</button></div></div>
            <div class="column is-6-tablet is-4-desktop"><div class="ext-card sumas"><h3>Sumas Pay</h3><p>Financiaci√≥n 100% digital y sin papeles para tecnolog√≠a.</p><a href="https://solicitud.mundosumas.com/v2/home/mai" target="_blank" class="btn-ext btn-sumas">üì≤ Autogestiona aqu√≠</a></div></div>
            <div class="column is-6-tablet is-4-desktop"><div class="ext-card bogota"><h3>Banco de Bogot√°</h3><p>Cr√©dito f√°cil y sin tr√°mites f√≠sicos. Respuesta inmediata.</p><a href="https://slm.bancodebogota.com/lyzz2kdc" target="_blank" class="btn-ext btn-bogota">üè¶ Iniciar solicitud</a></div></div>
            <div class="column is-6-tablet is-4-desktop"><div class="ext-card addi"><h3>Addi</h3><p>Compra lo que quieras y paga despu√©s. Pregunta por las cuotas con 0% de inter√©s.</p><a href="https://preapproval.addi.com/?allySlug=addi-preapproval" target="_blank" class="btn-ext btn-addi">üõçÔ∏è Ver pre-aprobado</a></div></div>
            <div class="column is-6-tablet is-4-desktop"><div class="ext-card siste"><h3>Sistecredito</h3><p>Activa tu cr√©dito personal y ll√©vate lo que necesites ahora mismo.</p><a href="https://personas.credinet.co/login" target="_blank" class="btn-ext btn-siste">üöÄ ¬°Lo quiero ya!</a></div></div>
            <div class="column is-6-tablet is-4-desktop"><div class="ext-card vanti"><h3 style="color:var(--color-vanti)">Vanti Listo</h3><p>Financia tus proyectos a trav√©s de tu factura de gas natural Vanti.</p><a href="https://autogestion.vantilisto.com/v3/opening-opportunity" target="_blank" class="btn-ext btn-vanti"><i data-lucide="zap"></i> Solicitar ahora</a></div></div>
        </div>
    </div>

    <!-- CONFIGURACI√ìN -->
    <div id="v-adm" class="section-view">
      <nav class="query-tabs">
        <div id="at-ali" class="query-tab-item is-active" onclick="switchAdminTab('ali')">Aliados</div>
        <div id="at-rol" class="query-tab-item" onclick="switchAdminTab('rol')">Roles</div>
        <div id="at-vin" class="query-tab-item" onclick="switchAdminTab('vin')">Vinc. Personalizada</div>
        <div id="at-ent" class="query-tab-item" onclick="switchAdminTab('ent')">Entidades</div>
        <div id="at-pla" class="query-tab-item" onclick="switchAdminTab('pla')">Planes</div>
      </nav>
      <div class="py-5">
          <!-- Aliados -->
          <div id="asec-ali" class="admin-sec is-active">
              <div class="box-admin">
                  <span class="admin-label">Nuevo Aliado Comercial</span>
                  <input id="new_cli_nom" class="input mb-3" style="font-weight: 600;" placeholder="Nombre Comercial">
                  <input id="new_cli_pass" class="input mb-3" style="font-weight: 600;" placeholder="Contrase√±a">
                  <div class="field">
                      <label class="label is-size-7" style="font-weight: 700;">Asignar Rol (Copia factores al aliado)</label>
                      <div class="select is-fullwidth">
                          <select id="new_cli_rol" style="font-weight: 600;"></select>
                      </div>
                  </div>
                  <button id="btn-admin-ali" class="button btn-modern is-save is-fullwidth mt-4" onclick="apiCall('crearCliente', {nombre: document.getElementById('new_cli_nom').value, contrasena: document.getElementById('new_cli_pass').value, rol: document.getElementById('new_cli_rol').value}, 'btn-admin-ali')">Registrar Aliado</button>
              </div>
          </div>
          
          <!-- ROLES -->
          <div id="asec-rol" class="admin-sec">
            <div class="box-admin">
                <span class="admin-label">Crear Nuevo Rol</span>
                <input id="new_rol_nom" class="input mb-4" style="font-weight: 600;" placeholder="Nombre del Rol (Ej: Mayorista)">
                <button id="btn-admin-rol" class="button btn-modern is-save is-fullwidth" onclick="apiCall('crearRol', {nombre: document.getElementById('new_rol_nom').value}, 'btn-admin-rol')">Crear Rol</button>
            </div>
            <div class="box-admin">
                <span class="admin-label">Asignar Factor Predeterminado a Rol</span>
                <div class="field"><label class="label is-size-7" style="font-weight: 700;">Rol</label><div class="select is-fullwidth"><select id="rel_rol_id" style="font-weight: 600;"></select></div></div>
                <div class="field"><label class="label is-size-7" style="font-weight: 700;">Entidad</label><div class="select is-fullwidth"><select id="rel_fin_id_rol" style="font-weight: 600;"></select></div></div>
                <div class="field mb-4"><label class="label is-size-7" style="font-weight: 700;">Factor Predefinido</label><input id="rel_fac_val_rol" class="input" style="font-weight: 600;" type="number" step="0.01" placeholder="0.00"></div>
                <button id="btn-admin-rol-vin" class="button btn-modern is-save is-fullwidth" onclick="apiCall('asignarFactorRol', {id_rol: document.getElementById('rel_rol_id').value, id_financiera: document.getElementById('rel_fin_id_rol').value, factor_cliente: document.getElementById('rel_fac_val_rol').value}, 'btn-admin-rol-vin')">Guardar Factor del Rol</button>
            </div>
          </div>

          <!-- Vinculaci√≥n Personalizada -->
          <div id="asec-vin" class="admin-sec"><div class="box-admin"><span class="admin-label">Vincular Factor Personalizado a Tienda</span><p class="is-size-7 has-text-grey mb-3 font-medium">√ösalo solo si la tienda no tiene rol o necesita una excepci√≥n.</p><div class="field"><label class="label is-size-7" style="font-weight: 700;">Tienda</label><div class="select is-fullwidth"><select id="rel_cli_id" style="font-weight: 600;"></select></div></div><div class="field"><label class="label is-size-7" style="font-weight: 700;">Entidad</label><div class="select is-fullwidth"><select id="rel_fin_id" style="font-weight: 600;"></select></div></div><div class="field mb-4"><label class="label is-size-7" style="font-weight: 700;">Factor Aliado</label><input id="rel_fac_val" class="input" style="font-weight: 600;" type="number" step="0.01" placeholder="0.00"></div><button id="btn-admin-vin" class="button btn-modern is-save is-fullwidth" onclick="apiCall('asignarFactorCliente', {id_cliente: document.getElementById('rel_cli_id').value, id_financiera: document.getElementById('rel_fin_id').value, factor_cliente: document.getElementById('rel_fac_val').value}, 'btn-admin-vin')">Guardar Vinculaci√≥n</button></div></div>
          
          <div id="asec-ent" class="admin-sec"><div class="box-admin"><span class="admin-label">Nueva Entidad Financiera</span><input id="new_fin_nom" class="input mb-3" style="font-weight: 600;" placeholder="Nombre Entidad"><label class="label is-size-7" style="font-weight: 700;">Factor Base</label><input id="new_fin_fac" class="input mb-4" style="font-weight: 600;" type="number" step="0.01" placeholder="0.00"><button id="btn-admin-ent" class="button btn-modern is-save is-fullwidth" onclick="apiCall('crearFinanciera', {nombre: document.getElementById('new_fin_nom').value, factor: document.getElementById('new_fin_fac').value}, 'btn-admin-ent')">Registrar Entidad</button></div></div>
          <div id="asec-pla" class="admin-sec"><div class="box-admin"><span class="admin-label">Planes de Entidades</span><div class="select is-fullwidth mb-3"><select id="plan_fin_id" style="font-weight: 600;"></select></div><div class="columns is-mobile is-multiline mb-2"><div class="column is-6"><label class="label is-size-7" style="font-weight: 700;">Frecuencia</label><div class="select is-fullwidth"><select id="plan_tipo" style="font-weight: 600;"><option value="Mensual">Mensual</option><option value="Quincenal">Quincenal</option><option value="Semanal">Semanal</option></select></div></div><div class="column is-6"><label class="label is-size-7" style="font-weight: 700;">M√°x Cuotas</label><input id="plan_num" class="input" style="font-weight: 600;" type="number"></div><div class="column is-6"><label class="label is-size-7" style="font-weight: 700;">% Int</label><input id="plan_int" class="input" style="font-weight: 600;" type="number" step="0.01"></div><div class="column is-6"><label class="label is-size-7" style="font-weight: 700;">% Fia</label><input id="plan_fia" class="input" style="font-weight: 600;" type="number" step="0.01"></div></div><button id="btn-admin-pla" class="button btn-modern is-save is-fullwidth mt-3" onclick="apiCall('crearPlanCuota', {id_financiera: document.getElementById('plan_fin_id').value, tipo_cuota: document.getElementById('plan_tipo').value, numero_cuotas: document.getElementById('plan_num').value, tasa_interes: document.getElementById('plan_int').value, tasa_fianza: document.getElementById('plan_fia').value}, 'btn-admin-pla')">Registrar Plan</button></div></div>
      </div>
    </div>

    <!-- CONSULTAS -->
    <div id="v-con" class="section-view">
      <nav class="query-tabs">
        <div id="m-cli" class="query-tab-item is-active" onclick="switchQuery('cli')">Aliados</div>
        <div id="m-rol" class="query-tab-item" onclick="switchQuery('rol')">Roles</div>
        <div id="m-fin" class="query-tab-item" onclick="switchQuery('fin')">Entidades</div>
        <div id="m-his" class="query-tab-item" onclick="switchQuery('his')">Historial</div>
      </nav>
      <div class="p-5">
        <div id="q-cli" class="q-section"><div class="table-container"><table class="table is-fullwidth is-striped is-clickable"><thead><tr><th>Nombre Aliado</th><th>Clave Acceso</th></tr></thead><tbody id="tb-clientes" style="font-weight: 500;"></tbody></table></div></div>
        <div id="q-rol" class="q-section" style="display:none;"><div class="table-container"><table class="table is-fullwidth is-striped is-clickable"><thead><tr><th>Nombre del Rol</th><th>Estado</th></tr></thead><tbody id="tb-roles" style="font-weight: 500;"></tbody></table></div></div>
        <div id="q-fin" class="q-section" style="display:none;"><div class="table-container"><table class="table is-fullwidth is-striped is-clickable"><thead><tr><th>Entidad Financiera</th><th>Factor Base</th></tr></thead><tbody id="tb-financieras" style="font-weight: 500;"></tbody></table></div></div>
        
        <div id="q-his" class="q-section" style="display:none;">
          <div class="filter-panel-history">
            <div class="columns is-multiline is-mobile">
                <div class="column is-12 mb-3">
                    <div class="field">
                        <label class="label is-small" style="text-transform: uppercase; letter-spacing: 0.1em; opacity:0.8;">Filtro R√°pido de Periodo</label>
                        <div class="select is-fullwidth is-period-select-large">
                            <select id="sel-periodo" onchange="handlePredefinedFilter(this.value)">
                                <option value="custom">üîç Filtro personalizado...</option>
                                <option value="semana">üìÖ Esta semana</option>
                                <option value="mes">üóìÔ∏è Este mes</option>
                                <option value="pasado">‚èÆÔ∏è El mes pasado</option>
                                <option value="anio">üìä Este a√±o</option>
                                <option value="anio_pasado">üìâ El a√±o pasado</option>
                                <option value="todo">üåê Mostrar todo</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="column is-5 py-1"><label class="label is-size-7" style="font-weight: 700;">Desde</label><input id="f-desde" class="input input-date-history" type="date" onchange="filterSimulations()"></div>
                <div class="column is-5 py-1"><label class="label is-size-7" style="font-weight: 700;">Hasta</label><input id="f-hasta" class="input input-date-history" type="date" onchange="filterSimulations()"></div>
                <div class="column is-2 py-1 is-flex is-align-items-flex-end"><button class="button is-brand is-fullwidth" style="height:45px; border-radius:10px; background-color: var(--brand-blue); color: white; border: none; box-shadow: 0 4px 6px rgba(44, 76, 140, 0.2);" onclick="filterSimulations()"><i data-lucide="filter"></i></button></div>
            </div>
          </div>
          <div class="table-container"><table class="table is-fullwidth is-striped is-narrow"><thead><tr><th>Fecha</th><th style="color:var(--brand-blue)">Tienda</th><th>Entidad</th><th>CC / Doc</th><th>Nombre Cliente</th><th class="has-text-right">Cr√©dito</th><th class="has-text-right">Utilidad</th><th class="has-text-right">Cuota</th><th class="has-text-centered">Plazo</th></tr></thead><tbody id="tb-simulaciones" style="font-weight: 500;"></tbody></table></div>
          <div class="kpi-grid">
            <div class="kpi-card"><div style="background:#eff4fa; color:var(--brand-blue); width:32px; height:32px; border-radius:8px; display:flex; align-items:center; justify-content:center; margin:0 auto 0.5rem;"><i data-lucide="bar-chart-2" style="width:18px;"></i></div><p style="font-size:0.6rem; font-weight:700; color:#64748b; text-transform:uppercase;">Registros</p><p id="total-count">0</p></div>
            <div class="kpi-card"><div style="background:#eff4fa; color:var(--gets-blue); width:32px; height:32px; border-radius:8px; display:flex; align-items:center; justify-content:center; margin:0 auto 0.5rem;"><i data-lucide="banknote" style="width:18px;"></i></div><p style="font-size:0.6rem; font-weight:700; color:#64748b; text-transform:uppercase;">Colocaci√≥n</p><p id="total-creditos">$ 0</p></div>
            <div class="kpi-card"><div style="background:#f1f9ef; color:var(--brand-green); width:32px; height:32px; border-radius:8px; display:flex; align-items:center; justify-content:center; margin:0 auto 0.5rem;"><i data-lucide="trending-up" style="width:18px;"></i></div><p style="font-size:0.6rem; font-weight:700; color:#64748b; text-transform:uppercase;">Utilidad Total</p><p id="total-utilidad">$ 0</p></div>
          </div>
        </div>
      </div>
    </div>
    <div class="footer-v">Soluciones Efectivas CTG | Gesti√≥n empresarial V2.107</div>
  </div>

  <!-- MODAL CONFIRMACI√ìN (Z-INDEX SUPERIOR) -->
  <div id="mod-confirm" class="modal"><div class="modal-background" onclick="closeConfirm()"></div><div class="modal-card" style="max-width: 350px;"><header class="modal-card-head has-background-danger"><p class="modal-card-title is-size-6 has-text-white has-text-weight-bold" style="font-family: 'Montserrat', sans-serif;">Confirmar Acci√≥n</p></header><section class="modal-card-body has-text-centered py-5"><div class="mb-4 has-text-danger"><i data-lucide="alert-triangle" style="width:48px; height:48px;"></i></div><p id="confirm-text" class="has-text-weight-bold" style="font-family: 'Montserrat', sans-serif;">¬øSeguro que desea eliminar este registro?</p></section><footer class="modal-card-foot is-justify-content-center"><button class="button is-light" onclick="closeConfirm()" style="font-family: 'Montserrat', sans-serif; font-weight: 700;">Cancelar</button><button id="btn-confirm-exec" class="button is-danger has-text-weight-bold" style="font-family: 'Montserrat', sans-serif;">S√≠, eliminar</button></footer></div></div>

  <!-- MODALES DE EDICI√ìN Y ROLES -->
  <div id="mod-cli" class="modal"><div class="modal-background" onclick="closeModals()"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title is-size-6 has-text-weight-bold" style="font-family: 'Montserrat', sans-serif;">Configurar Aliado</p></header><section class="modal-card-body"><input id="ed-cli-id" type="hidden"><div class="field"><label class="label is-small" style="font-weight: 700;">Tienda</label><input id="ed-cli-nom" class="input is-small" style="font-weight: 600;"></div><div class="field"><label class="label is-small" style="font-weight: 700;">Clave</label><input id="ed-cli-pass" class="input is-small" style="font-weight: 600;"></div><div class="field mt-3"><label class="label is-small" style="font-weight: 700;">Rol Asignado</label><div class="select is-small is-fullwidth"><select id="ed-cli-rol" onchange="renderAliadoVinculos(document.getElementById('ed-cli-id').value)" style="font-weight: 600;"></select></div></div><hr><div id="vinculos-container" class="table-container mt-4"></div></section><footer class="modal-card-foot"><button id="btn-del-ali" class="button is-danger mr-auto" style="border-radius:10px; font-weight:800; font-family: 'Montserrat', sans-serif;" onclick="askDeleteAliado()">Eliminar Aliado</button><button class="button is-light" onclick="closeModals()" style="font-family: 'Montserrat', sans-serif; font-weight: 700;">Cerrar</button><button id="btn-upd-ali" class="button btn-modern is-save" onclick="saveAliado()" style="font-family: 'Montserrat', sans-serif;">Actualizar Todo</button></footer></div></div>
  
  <div id="mod-rol" class="modal"><div class="modal-background" onclick="closeModals()"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title is-size-6 has-text-weight-bold" style="font-family: 'Montserrat', sans-serif;">Configurar Rol</p></header><section class="modal-card-body"><input id="ed-rol-id" type="hidden"><div class="field"><label class="label is-small" style="font-weight: 700;">Nombre del Rol</label><input id="ed-rol-nom" class="input is-small" style="font-weight: 600;"></div><hr><span class="admin-label">Permisos (Factores Predeterminados)</span><div id="rol-vinculos-container" class="table-container mt-4"></div></section><footer class="modal-card-foot"><button id="btn-del-rol" class="button is-danger mr-auto" style="border-radius:10px; font-weight:800; font-family: 'Montserrat', sans-serif;" onclick="askDeleteRol()">Eliminar Rol</button><button class="button is-light" onclick="closeModals()" style="font-family: 'Montserrat', sans-serif; font-weight: 700;">Cerrar</button><button id="btn-upd-rol" class="button btn-modern is-save" onclick="saveRol()" style="font-family: 'Montserrat', sans-serif;">Actualizar Rol</button></footer></div></div>

  <div id="mod-fin" class="modal"><div class="modal-background" onclick="closeModals()"></div><div class="modal-card" style="width:95%; max-width:700px;"><header class="modal-card-head"><p class="modal-card-title is-size-6 has-text-weight-bold" style="font-family: 'Montserrat', sans-serif;">Configurar Entidad</p></header><section class="modal-card-body"><input id="ed-fin-id" type="hidden"><div class="field"><label class="label is-small" style="font-weight: 700;">Entidad</label><input id="ed-fin-nom" class="input is-small" style="font-weight: 600;"></div><div class="field"><label class="label is-small" style="font-weight: 700;">Factor Base</label><input id="ed-fin-fac" class="input is-small" type="number" step="0.01" style="font-weight: 600;"></div><hr><span class="admin-label">Planes Asociados</span><div id="planes-container" class="table-container"></div></section><footer class="modal-card-foot"><button id="btn-del-fin" class="button is-danger mr-auto" style="border-radius:10px; font-weight:800; font-family: 'Montserrat', sans-serif;" onclick="askDeleteFinanciera()">Eliminar Entidad</button><button class="button is-light" onclick="closeModals()" style="font-family: 'Montserrat', sans-serif; font-weight: 700;">Cerrar</button><button id="btn-upd-fin" class="button btn-modern is-save" onclick="saveFinanciera()" style="font-family: 'Montserrat', sans-serif;">Actualizar</button></footer></div></div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzH2a6_gdBJ6uEzmms8qneHg5XnpThtWALqEjgZ9YYcEyMdG1ikYWb68POhtVELJdrdRA/exec";
    let db = { clientes: [], financieras: [], cuotas: [], porcentajes: [], simulaciones: [], roles: [], roles_permisos: [] };
    let currentUser = null, confirmCallback = null;

    window.onload = () => { lucide.createIcons(); setDefaultDates(); refresh(); };

    function showToast(msg, type = 'success') {
        const c = document.getElementById('toast-container'); const t = document.createElement('div');
        t.className = `toast is-${type}`;
        t.innerHTML = `<div class="toast-icon" style="color:${type==='success'?'var(--brand-green)':'var(--gets-red)'}"><i data-lucide="${type==='success'?'check-circle':'x-circle'}"></i></div><div class="toast-content" style="font-family: 'Montserrat', sans-serif;">${msg}</div>`;
        c.appendChild(t); lucide.createIcons(); setTimeout(() => t.classList.add('is-active'), 50);
        setTimeout(() => { t.classList.remove('is-active'); setTimeout(() => t.remove(), 600); }, 3500);
    }

    const toNum = (v) => { if (v === null || v === undefined || v === "") return 0; if (typeof v === 'number') return v; let clean = v.toString().replace(/[\$\.]/g, '').replace(',', '.').trim(); return parseFloat(clean) || 0; };
    const fmtCop = (v) => Number(v || 0).toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });

    function handlePriceInput(input) { let val = input.value.replace(/\D/g, ""); if (val === "") { input.value = ""; calc(); return; } input.value = "$ " + new Intl.NumberFormat('es-CO').format(parseInt(val)); calc(); }
    function setDefaultDates() { const n = new Date(); const format = (d) => { let m = ''+(d.getMonth()+1), day = ''+d.getDate(), y = d.getFullYear(); if (m.length<2) m='0'+m; if (day.length<2) day='0'+day; return [y, m, day].join('-'); }; document.getElementById('f-desde').value = format(new Date(n.getFullYear(), n.getMonth(), 1)); document.getElementById('f-hasta').value = format(n); }
    function handlePredefinedFilter(val) { const today = new Date(); let start = null, end = new Date(); const format = (d) => d.toISOString().split('T')[0]; switch(val) { case 'semana': let day = today.getDay(), diff = today.getDate() - day + (day === 0 ? -6 : 1); start = new Date(today.setDate(diff)); break; case 'mes': start = new Date(today.getFullYear(), today.getMonth(), 1); break; case 'pasado': start = new Date(today.getFullYear(), today.getMonth() - 1, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); break; case 'anio': start = new Date(today.getFullYear(), 0, 1); break; case 'anio_pasado': start = new Date(today.getFullYear() - 1, 0, 1); end = new Date(today.getFullYear() - 1, 11, 31); break; case 'todo': document.getElementById('f-desde').value = ""; document.getElementById('f-hasta').value = ""; filterSimulations(); return; } if(start) { document.getElementById('f-desde').value = format(start); document.getElementById('f-hasta').value = format(end); filterSimulations(); } }

    async function refresh() {
      document.getElementById('bg-sync-indicator').style.display = 'flex';
      const res = await fetchApi('getData');
      if(res) {
        db = res;
        fill('sel_cliente', db.clientes, 'id_cliente', 'nombre_cliente');
        fill('rel_cli_id', db.clientes, 'id_cliente', 'nombre_cliente', true);
        fill('rel_fin_id', db.financieras, 'id_financiera', 'nombre_financiera', true);
        fill('plan_fin_id', db.financieras, 'id_financiera', 'nombre_financiera', true);
        fill('rel_fin_id_rol', db.financieras, 'id_financiera', 'nombre_financiera', true);
        
        let rolesOpts = '<option value="">Sin Rol (Personalizado)</option>';
        if(db.roles && db.roles.length) {
            rolesOpts += db.roles.map(r => `<option value="${r.id_rol}">${r.nombre_rol}</option>`).join('');
        }
        if(document.getElementById('new_cli_rol')) document.getElementById('new_cli_rol').innerHTML = rolesOpts;
        if(document.getElementById('rel_rol_id')) document.getElementById('rel_rol_id').innerHTML = rolesOpts.replace('<option value="">Sin Rol (Personalizado)</option>','<option value="" disabled selected>Seleccione...</option>');
        
        renderTables();
        if(currentUser) {
            const store = db.clientes.find(c => String(c.id_cliente).trim() === String(currentUser.id_cliente).trim());
            document.getElementById('display-store-name').innerText = store ? store.nombre_cliente : "Aliado Comercial";
            document.getElementById('sel_cliente').value = currentUser.id_cliente;
            handleAllyChange();
        }
        document.getElementById('bg-sync-indicator').style.display = 'none';
      }
    }

    /* --- L√ìGICA DE LOGIN --- */
    function attemptLogin() {
      const u = document.getElementById('login-user').value.trim().toLowerCase(), p = document.getElementById('login-pass').value;
      const f = db.clientes.find(c => String(c.nombre_cliente).toLowerCase().trim() === u && String(c.contrasena) === p);
      if (f) { 
          currentUser = f; 
          document.getElementById('login-container').style.display = 'none'; 
          document.getElementById('app-container').style.display = 'block'; 
          
          const uName = String(currentUser.nombre_cliente).toLowerCase().trim();
          const isFullAdmin = uName === 'administrador';
          const isSemiAdmin = uName.startsWith('cia'); 
          const hasPrivileges = isFullAdmin || isSemiAdmin;

          document.getElementById('sel_cliente').disabled = !hasPrivileges; 
          document.getElementById('sel_cliente').value = currentUser.id_cliente; 
          document.getElementById('display-store-name').innerText = currentUser.nombre_cliente; 
          
          document.getElementById('t-adm').style.display = hasPrivileges ? 'block' : 'none'; 
          document.getElementById('t-con').style.display = isFullAdmin ? 'block' : 'none'; 

          document.getElementById('at-rol').style.display = isFullAdmin ? '' : 'none';
          document.getElementById('at-vin').style.display = isFullAdmin ? '' : 'none';
          document.getElementById('at-ent').style.display = isFullAdmin ? '' : 'none';
          document.getElementById('at-pla').style.display = isFullAdmin ? '' : 'none';

          switchAdminTab('ali');
          handleAllyChange(); 
          switchView('sim'); 
      } 
      else { showToast("Credenciales incorrectas", "error"); }
    }

    function fill(id, list, v, t, hasP = false) { const el = document.getElementById(id); if(!el) return; let opts = hasP ? '<option value="placeholder" selected disabled>Seleccionar...</option>' : ''; el.innerHTML = list.length ? opts + list.map(i => `<option value="${i[v]}">${i[t]}</option>`).join('') : '<option value="">Sin datos</option>'; }

    function renderTables() {
      const draw = (id, h) => { const el = document.getElementById(id); if(el) el.innerHTML = h; };
      draw('tb-clientes', db.clientes.map(c => `<tr onclick="openAliado('${c.id_cliente}')"><td>${c.nombre_cliente}</td><td><code style="font-family: monospace;">${c.contrasena}</code></td></tr>`).join(''));
      draw('tb-financieras', db.financieras.map(f => `<tr onclick="openFinanciera('${f.id_financiera}')"><td>${f.nombre_financiera}</td><td>${f.factor_financiera}</td></tr>`).join(''));
      draw('tb-roles', db.roles.map(r => `<tr onclick="openRol('${r.id_rol}')"><td>${r.nombre_rol}</td><td><span class="tag is-success is-light" style="font-weight: 700;">${r.estado || 'Activo'}</span></td></tr>`).join(''));
      filterSimulations(); 
    }

    function filterSimulations() {
      const d = document.getElementById('f-desde').value, h = document.getElementById('f-hasta').value;
      const t1 = d ? new Date(d + 'T00:00:00').getTime() : null, t2 = h ? new Date(h + 'T23:59:59').getTime() : null;
      let list = db.simulaciones || [];
      const parseP = (s) => { if(!s) return 0; const b = (s.fecha || s.Fecha).split('/'); return new Date(b[2], b[1]-1, b[0]).getTime(); };
      if(t1 && t2) list = list.filter(s => { const t = parseP(s); return t >= t1 && t <= t2; });
      let sc = 0, su = 0;
      const html = list.length ? list.slice().reverse().map(s => {
        const t = db.clientes.find(c => String(c.id_cliente).trim() === String(s.id_cliente).trim())?.nombre_cliente || 'Aliado';
        const e = db.financieras.find(fi => String(fi.id_financiera).trim() === String(s.id_financiera).trim())?.nombre_financiera || 'Entidad';
        const cred = toNum(s.valor_a_consignar), util = toNum(s.utilidad);
        sc += cred; su += util;
        return `<tr><td>${s.fecha || s.Fecha}</td><td style="color:var(--brand-blue); font-weight:800;">${t}</td><td>${e}</td><td>${s.cc || s.CC || '-'}</td><td>${s.nombre || s.Nombre || '-'}</td><td class="has-text-right">${fmtCop(cred)}</td><td class="has-text-right" style="color:var(--brand-green); font-weight:800;">${fmtCop(util)}</td><td class="has-text-right" style="font-weight:700;">${fmtCop(toNum(s.valor_cuota))}</td><td class="has-text-centered">${s.n_cuotas}</td></tr>`;
      }).join('') : '<tr><td colspan="9" class="has-text-centered py-6 has-text-grey" style="font-weight: 600;">Sin datos en el periodo</td></tr>';
      document.getElementById('tb-simulaciones').innerHTML = html; document.getElementById('total-count').innerText = list.length; document.getElementById('total-creditos').innerText = fmtCop(sc); document.getElementById('total-utilidad').innerText = fmtCop(su); lucide.createIcons();
    }

    function sendAssessorWhatsApp(service) { const msg = encodeURIComponent(`Hola, quisiera contactar a un asesor de Soluciones Efectivas CTG para solicitar informaci√≥n sobre el cr√©dito con ${service}.`); window.open(`https://wa.me/?text=${msg}`, '_blank'); }
    
    function sendWhatsApp(data) {
        const storeName = db.clientes.find(c => String(c.id_cliente).trim() === String(data.id_cliente).trim())?.nombre_cliente || "Tienda Aliada";
        const bankName = db.financieras.find(f => String(f.id_financiera).trim() === String(data.id_financiera).trim())?.nombre_financiera || "Entidad Financiera";
        const planObj = db.cuotas.find(c => String(c.id_cuota).trim() === String(data.id_cuota).trim());
        let message = `*NUEVA SIMULACION - SOLUCIONES EFECTIVAS CTG*\n\n*DATOS DE LA TIENDA*\n*‚óè* Tienda: ${storeName}\n*‚óè* Entidad: ${bankName}\n*‚óè* Plan: ${planObj ? planObj.tipo_cuota : ''} (${data.n_cuotas} cuotas)\n\n*DETALLES FINANCIEROS*\n*‚óè* Total Credito: ${fmtCop(data.valor_a_consignar)}\n*‚óè* Cuota Aprox: ${fmtCop(data.valor_cuota)}\n\n*DATOS DEL CLIENTE*\n*‚óè* Nombre: ${data.nombre}\n*‚óè* Documento: ${data.cc}\n*‚óè* Celular: ${data.celular}\n*‚óè* Correo: ${data.correo}`;
        if(bankName.toLowerCase().includes("brilla")) {
            message += `\n*‚óè* Direcci√≥n: ${document.getElementById('in_direccion').value || '-'}\n*‚óè* Art√≠culo: ${document.getElementById('in_articulo').value || '-'}\n\n*REFERENCIAS*\n*‚óè* Ref 1: ${document.getElementById('in_ref1_nom').value || '-'} (${document.getElementById('in_ref1_tel').value || '-'})\n*‚óè* Ref 2: ${document.getElementById('in_ref2_nom').value || '-'} (${document.getElementById('in_ref2_tel').value || '-'})`;
        }
        window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
    }

    async function fetchApi(action, data = null) { const url = new URL(SCRIPT_URL); url.searchParams.append('action', action); if(data) url.searchParams.append('data', JSON.stringify(data)); try { const res = await fetch(url.toString(), { method: 'GET', mode: 'cors' }); return (await res.json()).data; } catch (e) { return null; } }
    
    async function apiCall(action, data = null, btnId = null) { 
        if(btnId) { const b = document.getElementById(btnId); if(b) { b.classList.add('is-loading'); b.disabled = true; } }
        try {
            const res = await fetchApi(action, data); 
            if(res) { refresh(); showToast(res, "success"); clearAdminForms(action); }
        } catch (error) {
            showToast("Error de conexi√≥n", "error");
        } finally {
            if(btnId) { const b = document.getElementById(btnId); if(b) { b.classList.remove('is-loading'); b.disabled = false; } }
        }
    }

    function clearAdminForms(action) {
        if(action === 'crearCliente') { document.getElementById('new_cli_nom').value = ""; document.getElementById('new_cli_pass').value = ""; document.getElementById('new_cli_rol').value = ""; }
        else if(action === 'crearFinanciera') { document.getElementById('new_fin_nom').value = ""; document.getElementById('new_fin_fac').value = ""; }
        else if(action === 'crearRol') { document.getElementById('new_rol_nom').value = ""; }
        else if(action === 'asignarFactorRol') { document.getElementById('rel_fac_val_rol').value = ""; document.getElementById('rel_rol_id').value = ""; document.getElementById('rel_fin_id_rol').value = "placeholder"; }
        else if(action === 'asignarFactorCliente') { document.getElementById('rel_fac_val').value = ""; document.getElementById('rel_cli_id').value = "placeholder"; document.getElementById('rel_fin_id').value = "placeholder"; }
        else if(action === 'crearPlanCuota') { document.getElementById('plan_num').value = ""; document.getElementById('plan_int').value = ""; document.getElementById('plan_fia').value = ""; document.getElementById('plan_fin_id').value = "placeholder"; }
    }
    
    function switchView(v) { document.querySelectorAll('.section-view').forEach(e => e.classList.remove('is-active-view')); document.querySelectorAll('.tab-item').forEach(e => e.classList.remove('is-active')); document.getElementById('v-' + v).classList.add('is-active-view'); document.getElementById('t-' + v).classList.add('is-active'); document.getElementById('app-container').classList.toggle('wide', v === 'con' || v === 'ext' || v === 'adm'); }
    function switchQuery(sec) { document.querySelectorAll('#v-con .q-section').forEach(s => s.style.display = 'none'); document.querySelectorAll('#v-con .query-tab-item').forEach(a => a.classList.remove('is-active')); const target = document.getElementById('q-' + sec); if(target) target.style.display = 'block'; const tab = document.getElementById('m-' + sec); if(tab) tab.classList.add('is-active'); }
    function switchAdminTab(sec) { document.querySelectorAll('.admin-sec').forEach(s => s.classList.remove('is-active')); document.querySelectorAll('#v-adm .query-tab-item').forEach(a => a.classList.remove('is-active')); const target = document.getElementById('asec-' + sec); if(target) target.classList.add('is-active'); const tab = document.getElementById('at-' + sec); if(tab) tab.classList.add('is-active'); }
    
    function handleAllyChange() { 
        const id = document.getElementById('sel_cliente').value; 
        const cli = db.clientes.find(c => String(c.id_cliente).trim() === String(id).trim());
        let assignedIds = [];
        if(cli && cli.rol) {
            assignedIds = db.roles_permisos.filter(p => String(p.ROL).trim() === String(cli.rol).trim()).map(p => String(p.id_financiera).trim());
        } else {
            assignedIds = db.porcentajes.filter(p => String(p.id_cliente).trim() === String(id).trim()).map(p => String(p.id_financiera).trim()); 
        }
        fill('sel_financiera', db.financieras.filter(f => assignedIds.includes(String(f.id_financiera).trim())), 'id_financiera', 'nombre_financiera', true); 
    }
    
    function loadPlanes() { const idFin = document.getElementById('sel_financiera').value; const finObj = db.financieras.find(f => String(f.id_financiera).trim() === String(idFin).trim()); if(finObj && finObj.nombre_financiera.toLowerCase().includes("brilla")) { document.getElementById('brilla-fields').style.display = 'block'; } else { document.getElementById('brilla-fields').style.display = 'none'; } fill('sel_plan', db.cuotas.filter(c => String(c.id_financiera).trim() === String(idFin).trim()).map(c => ({id: c.id_cuota, text: c.tipo_cuota.toUpperCase() + ' ('+c.numero_cuotas+')'})), 'id', 'text', true); }
    function loadNumCuotas() { const p = db.cuotas.find(c => String(c.id_cuota).trim() === String(document.getElementById('sel_plan').value).trim()); if(p) { let o = '<option value="" selected disabled>...</option>'; for(let i=1; i <= toNum(p.numero_cuotas); i++) o += `<option value="${i}">${i} cuota${i>1?'s':''}</option>`; document.getElementById('sel_n_cuotas').innerHTML = o; } calc(); }

    function calc() {
      const idCli = document.getElementById('sel_cliente').value, idFin = document.getElementById('sel_financiera').value, idCuo = document.getElementById('sel_plan').value, n = parseInt(document.getElementById('sel_n_cuotas').value) || 0, p = toNum(document.getElementById('in_precio').value);
      if (!idCli || idCli === "placeholder" || !idFin || idFin === "placeholder") return null;
      
      let factor = null;
      const cli = db.clientes.find(c => String(c.id_cliente).trim() === String(idCli).trim());
      
      if (cli && cli.rol) {
          const pRol = db.roles_permisos.find(rp => String(rp.ROL).trim() === String(cli.rol).trim() && String(rp.id_financiera).trim() === String(idFin).trim());
          if (pRol) factor = toNum(pRol.factor_cliente);
      }
      if (!factor) {
          const rel = db.porcentajes.find(rp => String(rp.id_cliente).trim() === String(idCli).trim() && String(rp.id_financiera).trim() === String(idFin).trim());
          if (rel) factor = toNum(rel.factor_cliente);
      }

      const cuo = db.cuotas.find(c => String(c.id_cuota).trim() === String(idCuo).trim());
      if(!factor || !cuo || p <= 0 || n <= 0) { render(0,0); return null; }
      
      const cons = p / factor;
      const tI = toNum(cuo.tasa_interes) / 100;
      const tF = toNum(cuo.tasa_fianza) / 100;
      const cB = (cons + (cons * tI * n)) / n;
      const vC = cB + (cB * tF);
      
      render(cons, vC);
      return { id_cliente: idCli, id_financiera: idFin, id_cuota: idCuo, precio_producto: p, valor_a_consignar: cons, valor_cuota: vC, n_cuotas: n };
    }

    function render(c, q) { document.getElementById('out_consignar').innerText = fmtCop(c); document.getElementById('out_cuota').innerText = fmtCop(q); }
    function clearInputs() { ['in_cc', 'in_celular', 'in_nombre_sol', 'in_correo', 'in_precio', 'in_direccion', 'in_articulo', 'in_ref1_nom', 'in_ref1_tel', 'in_ref2_nom', 'in_ref2_tel'].forEach(id => { const el = document.getElementById(id); if(el) el.value = ""; }); render(0,0); }
    
    function validateAndSave() {
      const checks = ['in_cc', 'in_celular', 'in_nombre_sol', 'in_correo', 'sel_financiera', 'sel_plan', 'sel_n_cuotas', 'in_precio'];
      for (let id of checks) { if (!document.getElementById(id).value || document.getElementById(id).value === "placeholder") { showToast("Complete todos los campos.", 'error'); return; } }
      const mainBtn = document.getElementById('btn-main-action');
      mainBtn.classList.add('is-loading');
      mainBtn.disabled = true;
      const data = { ...calc(), cc: document.getElementById('in_cc').value, nombre: document.getElementById('in_nombre_sol').value, correo: document.getElementById('in_correo').value, celular: document.getElementById('in_celular').value };
      sendWhatsApp(data); 
      apiCall('guardarSimulacion', data, 'btn-main-action'); 
      clearInputs();
    }
    
    function openAliado(id) {
        const c = db.clientes.find(x => String(x.id_cliente).trim() === String(id).trim());
        if(!c) return;
        document.getElementById('ed-cli-id').value = c.id_cliente;
        document.getElementById('ed-cli-nom').value = c.nombre_cliente;
        document.getElementById('ed-cli-pass').value = c.contrasena;
        
        let rolesOpts = '<option value="">Sin Rol (Personalizado)</option>';
        if(db.roles && db.roles.length) { rolesOpts += db.roles.map(r => `<option value="${r.id_rol}" ${c.rol === r.id_rol ? 'selected' : ''}>${r.nombre_rol}</option>`).join(''); }
        document.getElementById('ed-cli-rol').innerHTML = rolesOpts;
        
        renderAliadoVinculos(id);
        document.getElementById('mod-cli').classList.add('is-active');
    }

    function renderAliadoVinculos(idCli) {
        const rolSelect = document.getElementById('ed-cli-rol').value;
        let h = '';
        if (rolSelect) {
            h = '<p class="is-size-7 has-text-info mb-2" style="font-weight: 600;">Este aliado hereda los factores de su rol.</p>';
            h += '<table class="table is-fullwidth is-narrow is-bordered"><thead><tr><th>Entidad</th><th>Factor Heredado</th></tr></thead><tbody style="font-weight: 500;">';
            db.financieras.forEach(f => {
                const r = db.roles_permisos.find(p => String(p.ROL).trim() === String(rolSelect).trim() && String(p.id_financiera).trim() === String(f.id_financiera).trim());
                h += `<tr><td class="is-size-7" style="font-weight: 700;">${f.nombre_financiera}</td><td><strong style="font-weight: 800;">${r?toNum(r.factor_cliente):'<span class="has-text-grey-light">N/A</span>'}</strong></td></tr>`;
            });
            h += '</tbody></table>';
        } else {
            h = '<p class="is-size-7 has-text-grey mb-2" style="font-weight: 600;">Factores personalizados (Sin Rol).</p>';
            h += '<table class="table is-fullwidth is-narrow is-bordered"><thead><tr><th>Entidad</th><th>Factor</th><th class="has-text-centered">X</th></tr></thead><tbody>';
            db.financieras.forEach(f => {
                const r = db.porcentajes.find(p => String(p.id_cliente).trim() === String(idCli).trim() && String(p.id_financiera).trim() === String(f.id_financiera).trim());
                h += `<tr><td class="is-size-7" style="font-weight: 700;">${f.nombre_financiera}</td><td><input class="input is-small v-fac" data-fin="${f.id_financiera}" type="number" step="0.01" value="${r?toNum(r.factor_cliente):''}" style="font-weight: 600;"></td><td class="has-text-centered">${r?`<span class="btn-delete-row" onclick="confirmDeleteVinculo('${idCli}','${f.id_financiera}')"><i data-lucide="trash-2" style="width:14px;"></i></span>`:''}</td></tr>`;
            });
            h += '</tbody></table>';
        }
        document.getElementById('vinculos-container').innerHTML = h;
        lucide.createIcons();
    }

    function openRol(id) {
        const r = db.roles.find(x => String(x.id_rol).trim() === String(id).trim());
        if(!r) return;
        document.getElementById('ed-rol-id').value = r.id_rol;
        document.getElementById('ed-rol-nom').value = r.nombre_rol;
        
        let h = '<table class="table is-fullwidth is-narrow is-bordered"><thead><tr><th>Entidad</th><th>Factor Base</th><th class="has-text-centered">X</th></tr></thead><tbody>';
        db.financieras.forEach(f => {
            const p = db.roles_permisos.find(x => String(x.ROL).trim() === String(id).trim() && String(x.id_financiera).trim() === String(f.id_financiera).trim());
            h += `<tr><td class="is-size-7" style="font-weight: 700;">${f.nombre_financiera}</td><td><input class="input is-small r-fac" data-fin="${f.id_financiera}" type="number" step="0.01" value="${p?toNum(p.factor_cliente):''}" style="font-weight: 600;"></td><td class="has-text-centered">${p?`<span class="btn-delete-row" onclick="confirmDeleteVinculoRol('${id}','${f.id_financiera}')"><i data-lucide="trash-2" style="width:14px;"></i></span>`:''}</td></tr>`;
        });
        h += '</tbody></table>';
        document.getElementById('rol-vinculos-container').innerHTML = h;
        document.getElementById('mod-rol').classList.add('is-active');
        lucide.createIcons();
    }

    async function saveRol() {
        const idRol = document.getElementById('ed-rol-id').value;
        const factores = [];
        document.querySelectorAll('.r-fac').forEach(input => {
            if(input.value !== "") factores.push({ id_fin: input.dataset.fin, valor: input.value });
        });
        await apiCall('updateRol', { id_rol: idRol, nombre_rol: document.getElementById('ed-rol-nom').value, factores: factores }, 'btn-upd-rol');
        closeModals();
    }

    function openFinanciera(id) {
        const f = db.financieras.find(x => String(x.id_financiera).trim() === String(id).trim());
        if(!f) return;
        document.getElementById('ed-fin-id').value = f.id_financiera;
        document.getElementById('ed-fin-nom').value = f.nombre_financiera;
        document.getElementById('ed-fin-fac').value = f.factor_financiera;
        let h = '<table class="table is-fullwidth is-narrow is-bordered"><thead><tr><th>Plan</th><th>% Int</th><th>% Fia</th></tr></thead><tbody>';
        db.cuotas.filter(c => String(c.id_financiera).trim() === String(id).trim()).forEach(c => {
            h += `<tr><td class="is-size-7" style="font-weight: 700;">${c.tipo_cuota.toUpperCase()} (${c.numero_cuotas})</td><td><input class="input is-small p-int" value="${toNum(c.tasa_interes)}" style="font-weight: 600;"></td><td><input class="input is-small p-fia" value="${toNum(c.tasa_fianza)}" style="font-weight: 600;"></td></tr>`;
        });
        document.getElementById('planes-container').innerHTML = h + '</tbody></table>';
        document.getElementById('mod-fin').classList.add('is-active'); lucide.createIcons();
    }

    async function saveAliado() { 
        const idCli = document.getElementById('ed-cli-id').value;
        const rolSelect = document.getElementById('ed-cli-rol').value;
        const factores = [];
        if (!rolSelect) {
            document.querySelectorAll('.v-fac').forEach(input => { if(input.value !== "") factores.push({ id_fin: input.dataset.fin, valor: input.value }); });
        }
        await apiCall('updateCliente', { id_cliente: idCli, nombre_cliente: document.getElementById('ed-cli-nom').value, contrasena: document.getElementById('ed-cli-pass').value, rol: rolSelect, factores: factores }, 'btn-upd-ali');
        closeModals(); 
    }

    async function saveFinanciera() { await apiCall('updateFinanciera', { id_financiera: document.getElementById('ed-fin-id').value, nombre_financiera: document.getElementById('ed-fin-nom').value, factor_financiera: document.getElementById('ed-fin-fac').value }, 'btn-upd-fin'); closeModals(); }
    
    function askDeleteAliado() { openConfirm("¬øSeguro que desea eliminar este Aliado? Se borrar√°n todas sus vinculaciones.", async () => { await apiCall('deleteCliente', { id_cliente: document.getElementById('ed-cli-id').value }, 'btn-del-ali'); closeModals(); }); }
    function askDeleteFinanciera() { openConfirm("¬øSeguro que desea eliminar esta Entidad? Se borrar√°n vinculaciones y planes.", async () => { await apiCall('deleteFinanciera', { id_financiera: document.getElementById('ed-fin-id').value }, 'btn-del-fin'); closeModals(); }); }
    function askDeleteRol() { openConfirm("¬øSeguro que desea eliminar este Rol? Se borrar√°n todos sus permisos.", async () => { await apiCall('deleteRol', { id_rol: document.getElementById('ed-rol-id').value }, 'btn-del-rol'); closeModals(); }); }

    function openConfirm(text, callback) { document.getElementById('confirm-text').innerText = text; document.getElementById('mod-confirm').classList.add('is-active'); confirmCallback = callback; document.getElementById('btn-confirm-exec').onclick = async () => { const b = document.getElementById('btn-confirm-exec'); b.classList.add('is-loading'); await confirmCallback(); b.classList.remove('is-loading'); closeConfirm(); }; }
    function closeConfirm() { document.getElementById('mod-confirm').classList.remove('is-active'); }
    function closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('is-active')); }
    
    function confirmDeleteVinculo(idCli, idFin) { openConfirm("¬øBorrar factor personalizado?", async () => { await apiCall('deletePorcentaje', { id_cliente: idCli, id_financiera: idFin }); openAliado(idCli); }); }
    function confirmDeleteVinculoRol(idRol, idFin) { openConfirm("¬øBorrar factor de este rol?", async () => { await apiCall('deletePorcentajeRol', { id_rol: idRol, id_financiera: idFin }); openRol(idRol); }); }
  </script>
</body>
</html>
