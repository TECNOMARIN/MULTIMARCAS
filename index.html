<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gets Solutions | Versión 1.6</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #6d28d9 0%, #3b82f6 100%);
      --gets-purple: #9333ea;
      --gets-dark: #1e293b;
      --gets-light: #f8fafc;
    }
    
    body { 
      background: var(--primary-gradient); 
      min-height: 100vh; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      padding: 1rem; 
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    }
    
    .main-card { 
      width: 100%; 
      max-width: 480px; 
      background: white; 
      border-radius: 20px; 
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); 
      overflow: hidden; 
      display: none; 
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    #login-view { 
      padding: 3rem 2rem; 
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .login-icon-box {
      background: #f5f3ff;
      color: var(--gets-purple);
      padding: 1rem;
      border-radius: 50%;
      margin-bottom: 1.5rem;
    }

    .login-header-group {
      margin-bottom: 2.5rem;
      width: 100%;
      text-align: center;
    }

    .login-header-group .title { margin-bottom: 0.5rem !important; color: var(--gets-dark); }
    .login-header-group .subtitle { margin-top: 0 !important; color: #64748b; }

    .brand-header { 
      padding: 1.5rem; 
      text-align: center; 
      background: white;
      border-bottom: 1px solid #f1f5f9;
    }
    .brand-logo { max-height: 50px; width: auto; }

    .custom-tabs { display: flex; background: #fdfdfd; border-bottom: 1px solid #f1f5f9; }
    .tab-item { 
      flex: 1; padding: 1rem 0.5rem; text-align: center; cursor: pointer; 
      color: #94a3b8; font-weight: 700; font-size: 0.8rem; text-transform: uppercase;
      transition: all 0.2s ease;
      border-bottom: 3px solid transparent;
    }
    .tab-item.is-active { color: var(--gets-purple); border-bottom-color: var(--gets-purple); background: white; }

    .section-view { display: none; padding: 1.5rem; }
    .is-active-view { display: block; }

    .admin-label { 
      font-size: 0.7rem; font-weight: 800; color: var(--gets-purple); 
      text-transform: uppercase; margin-bottom: 0.75rem; display: block;
      letter-spacing: 0.05em;
    }
    
    .solicitante-section { 
      border-left: 4px solid var(--gets-purple); 
      padding-left: 1rem; 
      margin-bottom: 1.75rem; 
      background: #fafafa;
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
      border-radius: 0 8px 8px 0;
    }

    .box-admin { 
      border: 1px solid #e2e8f0; 
      padding: 1.25rem; 
      border-radius: 12px; 
      margin-bottom: 1.25rem; 
      background: #f8fafc; 
    }

    .res-grid { 
      background: #1e293b; 
      border-radius: 15px; 
      padding: 1.25rem; 
      margin-top: 1.5rem; 
      display: grid; 
      grid-template-columns: 1fr; 
      gap: 1rem; 
    }
    .res-item { text-align: center; }
    .res-item p:first-child { font-size: 0.7rem; color: #94a3b8; font-weight: 700; text-transform: uppercase; margin-bottom: 0.25rem; }
    .res-item p:last-child { font-size: 1.4rem; color: white; font-weight: 800; }
    .res-divider { height: 1px; background: #334155; margin: 0.5rem 0; }

    .footer-v { 
      text-align: center; padding: 1rem; font-size: 0.7rem; 
      color: #94a3b8; background: #f8fafc; border-top: 1px solid #f1f5f9; 
      font-weight: 600;
    }

    @media screen and (max-width: 480px) {
      body { padding: 0; }
      .main-card { border-radius: 0; min-height: 100vh; max-width: none; }
      .section-view { padding: 1.25rem 1rem; }
      .login-header-group { margin-bottom: 1.5rem; }
      #login-view { padding: 2rem 1.5rem; }
    }

    .button.is-purple { background-color: var(--gets-purple); color: white; border: none; font-weight: 700; }
    .button.is-purple:hover { background-color: #7e22ce; color: white; }
    .input { border-radius: 8px; border-color: #e2e8f0; }
    .input:focus { border-color: var(--gets-purple); box-shadow: 0 0 0 0.125em rgba(147, 51, 234, 0.15); }
  </style>
</head>
<body>

  <div id="loading" class="loader-overlay">
    <div class="button is-loading is-large is-white"></div>
    <p class="mt-4 has-text-grey" id="loader_text">Iniciando sistema seguro...</p>
  </div>

  <!-- PANTALLA DE LOGIN -->
  <div id="login-container" class="main-card" style="display: block;">
    <div class="brand-header">
      <img src="https://appgets.solutions/img/logoempresa.png" alt="Logo" class="brand-logo">
    </div>
    <div id="login-view">
      <div class="login-icon-box"><i data-lucide="shield-check" style="width: 32px; height: 32px;"></i></div>
      <div class="login-header-group">
        <h2 class="title is-4">Ingreso Seguro</h2>
        <p class="subtitle is-6">Identifícate para acceder al sistema</p>
      </div>
      <div class="field is-fullwidth" style="width: 100%;">
        <label class="label is-small has-text-grey">Nombre de la Tienda / Aliado</label>
        <div class="control has-icons-left">
          <input id="login-user" class="input is-medium" type="text" placeholder="Nombre oficial">
          <span class="icon is-small is-left"><i data-lucide="store"></i></span>
        </div>
      </div>
      <div class="field is-fullwidth mt-4" style="width: 100%;">
        <label class="label is-small has-text-grey">Contraseña de Acceso</label>
        <div class="control has-icons-left">
          <input id="login-pass" class="input is-medium" type="password" placeholder="••••••••" onkeypress="if(event.key === 'Enter') attemptLogin()">
          <span class="icon is-small is-left"><i data-lucide="key"></i></span>
        </div>
      </div>
      <p id="login-error" class="help is-danger is-hidden mt-3">Credenciales no válidas. Reintente.</p>
      <button class="button is-purple is-fullwidth is-medium mt-6" onclick="attemptLogin()">Entrar al Sistema</button>
    </div>
    <div class="footer-v">Gets Solutions | Seguridad V1.6</div>
  </div>

  <!-- PANTALLA PRINCIPAL -->
  <div id="app-container" class="main-card">
    <div class="brand-header">
      <div class="is-flex is-justify-content-space-between is-align-items-center">
        <img src="https://appgets.solutions/img/logoempresa.png" alt="Logo" class="brand-logo">
        <button class="button is-light is-small has-text-danger" onclick="logout()">
          <span class="icon"><i data-lucide="log-out"></i></span><span>Salir</span>
        </button>
      </div>
    </div>

    <div class="custom-tabs" id="main-tabs">
      <div id="t-sim" class="tab-item is-active" onclick="switchView('sim')">Calculadora</div>
      <div id="t-adm" class="tab-item" style="display:none;" onclick="switchView('adm')">Configuración</div>
    </div>

    <!-- CALCULADORA -->
    <div id="v-sim" class="section-view is-active-view">
      <div class="solicitante-section">
        <span class="admin-label">Datos del Solicitante</span>
        <div class="columns is-mobile is-multiline mb-0">
          <div class="column is-6 py-1"><input id="in_cc" class="input is-small" type="text" placeholder="Documento (CC)"></div>
          <div class="column is-6 py-1"><input id="in_celular" class="input is-small" type="tel" placeholder="Celular"></div>
          <div class="column is-12 py-1"><input id="in_nombre_sol" class="input is-small" type="text" placeholder="Nombre completo"></div>
          <div class="column is-12 py-1"><input id="in_correo" class="input is-small" type="email" placeholder="Correo electrónico"></div>
        </div>
      </div>

      <div class="field">
        <label class="label is-small">Aliado / Tienda</label>
        <div class="select is-fullwidth">
          <select id="sel_cliente" class="has-text-weight-bold" onchange="handleStoreChange()"></select>
        </div>
      </div>
      
      <div class="field">
        <label class="label is-small">Entidad Financiera (Asignadas)</label>
        <div class="select is-fullwidth"><select id="sel_financiera" onchange="loadPlanes()"></select></div>
      </div>

      <div class="columns is-mobile mb-0">
        <div class="column">
          <label class="label is-small">Plan</label>
          <div class="select is-fullwidth"><select id="sel_plan" onchange="loadNumCuotas()"></select></div>
        </div>
        <div class="column">
          <label class="label is-small">Cuotas</label>
          <div class="select is-fullwidth"><select id="sel_n_cuotas" onchange="calc()"></select></div>
        </div>
      </div>

      <div class="field">
        <label class="label is-small">Precio del Producto ($)</label>
        <input id="in_precio" class="input is-medium" type="number" placeholder="0.00" oninput="calc()">
      </div>
      
      <div class="res-grid">
        <div class="res-item">
          <p>Total Crédito</p>
          <p id="out_consignar">$ 0</p>
        </div>
        <div class="res-divider"></div>
        <div class="res-item">
          <p>Valor Cuota (Aproximado)</p>
          <p id="out_cuota" style="color: #a855f7;">$ 0</p>
        </div>
      </div>
      
      <button id="btn_save" class="button is-purple is-fullwidth is-medium mt-5" onclick="validateAndSave()">Registrar Simulación</button>
    </div>

    <!-- CONFIGURACIÓN -->
    <div id="v-adm" class="section-view">
      <div class="box-admin">
        <span class="admin-label">Administración del Sistema</span>
        <p class="is-size-7 has-text-grey mb-4">Módulo exclusivo para gestión de aliados y parámetros financieros.</p>
        <div class="field mb-2"><input id="new_cli_nom" class="input is-small" placeholder="Nombre Tienda"></div>
        <div class="field has-addons">
          <div class="control is-expanded"><input id="new_cli_pass" class="input is-small" type="text" placeholder="Nueva Clave"></div>
          <div class="control"><button class="button is-purple is-small" onclick="apiCall('crearCliente')">Crear</button></div>
        </div>
      </div>
      <button class="button is-light is-fullwidth is-small" onclick="refresh()">Actualizar Base de Datos</button>
    </div>
    
    <div class="footer-v">Gets Solutions Integral | V1.6</div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzH2a6_gdBJ6uEzmms8qneHg5XnpThtWALqEjgZ9YYcEyMdG1ikYWb68POhtVELJdrdRA/exec";
    let db = { clientes: [], financieras: [], cuotas: [], porcentajes: [] };
    let currentUser = null;

    window.onload = () => { lucide.createIcons(); refresh(); };

    async function refresh() {
      document.getElementById('loading').style.display = 'flex';
      const res = await fetchApi('getData');
      if(res) {
        db = res;
        fill('sel_cliente', db.clientes, 'id_cliente', 'nombre_cliente');
        document.getElementById('loading').style.display = 'none';
      }
    }

    function attemptLogin() {
      const userVal = document.getElementById('login-user').value.trim().toLowerCase();
      const passVal = document.getElementById('login-pass').value;
      const errorEl = document.getElementById('login-error');
      const found = db.clientes.find(c => String(c.nombre_cliente).toLowerCase().trim() === userVal && String(c.contrasena) === passVal);

      if (found) {
        currentUser = found;
        errorEl.classList.add('is-hidden');
        setupUI();
      } else {
        errorEl.classList.remove('is-hidden');
      }
    }

    function setupUI() {
      document.getElementById('login-container').style.display = 'none';
      document.getElementById('app-container').style.display = 'block';
      
      const isAdmin = String(currentUser.nombre_cliente).toLowerCase() === 'administrador';
      const selCli = document.getElementById('sel_cliente');
      
      selCli.disabled = !isAdmin;
      selCli.value = currentUser.id_cliente;
      
      document.getElementById('t-adm').style.display = isAdmin ? 'block' : 'none';
      loadAssignedEntities(currentUser.id_cliente);
      switchView('sim');
    }

    function loadAssignedEntities(clientId) {
      const assignedIds = db.porcentajes
        .filter(p => String(p.id_cliente) === String(clientId))
        .map(p => String(p.id_financiera));

      const filteredFinancieras = db.financieras.filter(f => assignedIds.includes(String(f.id_financiera)));
      fill('sel_financiera', filteredFinancieras, 'id_financiera', 'nombre_financiera', true);
      
      document.getElementById('sel_plan').innerHTML = '<option value="placeholder" disabled selected>Seleccione entidad...</option>';
      document.getElementById('sel_n_cuotas').innerHTML = '<option value="" disabled selected>...</option>';
      calc();
    }

    function handleStoreChange() {
      const selectedClientId = document.getElementById('sel_cliente').value;
      if (selectedClientId && selectedClientId !== "placeholder") {
        loadAssignedEntities(selectedClientId);
      }
    }

    function logout() {
      currentUser = null;
      document.getElementById('login-user').value = "";
      document.getElementById('login-pass').value = "";
      document.getElementById('app-container').style.display = 'none';
      document.getElementById('login-container').style.display = 'block';
    }

    function validateAndSave() {
      const checks = [
        { id: 'in_cc', label: 'Documento (CC)' },
        { id: 'in_celular', label: 'Celular' },
        { id: 'in_nombre_sol', label: 'Nombre Completo' },
        { id: 'in_correo', label: 'Correo Electrónico', isEmail: true },
        { id: 'sel_financiera', label: 'Entidad Financiera' },
        { id: 'sel_plan', label: 'Plan de Pagos' },
        { id: 'sel_n_cuotas', label: 'Número de Cuotas' },
        { id: 'in_precio', label: 'Precio del Producto' }
      ];

      for (let field of checks) {
        const inputEl = document.getElementById(field.id);
        const val = inputEl.value.trim();

        if (!val || val === "placeholder" || val === "") {
          alert(`Dato faltante: Por favor ingrese el "${field.label}" para continuar.`);
          inputEl.focus();
          return;
        }

        // VALIDACIÓN DE FORMATO DE CORREO
        if (field.isEmail) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(val)) {
            alert(`Correo inválido: La información registrada en "${field.label}" no tiene un formato válido (ej: usuario@correo.com).`);
            inputEl.focus();
            return;
          }
        }
      }
      apiCall('guardarSimulacion');
    }

    async function fetchApi(action, params = {}) {
      const url = new URL(SCRIPT_URL);
      url.searchParams.append('action', action);
      for (const key in params) url.searchParams.append(key, params[key]);
      try {
        const response = await fetch(url.toString(), { method: 'GET', mode: 'cors' });
        const json = await response.json();
        return json.status === 'success' ? json.data : (alert("Error: " + json.message), null);
      } catch (e) { console.error(e); return null; }
    }

    async function apiCall(action) {
      const btn = event.currentTarget;
      btn.classList.add('is-loading');
      let params = {};
      if(action === 'crearCliente') params.data = JSON.stringify({ nombre: document.getElementById('new_cli_nom').value, contrasena: document.getElementById('new_cli_pass').value });
      else if(action === 'guardarSimulacion') { 
        const data = calc(); 
        data.cc = document.getElementById('in_cc').value; 
        data.nombre = document.getElementById('in_nombre_sol').value;
        data.correo = document.getElementById('in_correo').value; 
        data.celular = document.getElementById('in_celular').value;
        params.data = JSON.stringify(data); 
      }

      const res = await fetchApi(action, params);
      btn.classList.remove('is-loading');
      if(res) { alert(res); if(action === 'guardarSimulacion') clearInputs(); refresh(); }
    }

    function clearInputs() {
      ['in_cc', 'in_celular', 'in_nombre_sol', 'in_correo', 'in_precio'].forEach(id => document.getElementById(id).value = "");
      document.getElementById('out_consignar').innerText = "$ 0";
      document.getElementById('out_cuota').innerText = "$ 0";
    }

    function fill(id, list, v, t, hasPlaceholder = false) {
      const el = document.getElementById(id);
      if(!el) return;
      let opts = hasPlaceholder ? '<option value="placeholder" selected disabled>Seleccione una opción...</option>' : '';
      el.innerHTML = (list && list.length) ? opts + list.map(i => `<option value="${i[v]}">${i[t]}</option>`).join('') : '<option value="">(Sin registros)</option>';
    }

    function switchView(v) {
      document.querySelectorAll('.section-view').forEach(e => e.classList.remove('is-active-view'));
      document.querySelectorAll('.tab-item').forEach(e => e.classList.remove('is-active'));
      document.getElementById('v-' + v).classList.add('is-active-view');
      document.getElementById('t-' + v).classList.add('is-active');
    }

    function loadPlanes() {
      const idFin = document.getElementById('sel_financiera').value;
      if (!idFin || idFin === "placeholder") return;
      const filtered = db.cuotas.filter(c => String(c.id_financiera) === idFin);
      const el = document.getElementById('sel_plan');
      el.innerHTML = filtered.length ? '<option value="placeholder" selected disabled>Seleccione un plan...</option>' + filtered.map(c => `<option value="${c.id_cuota}">${c.tipo_cuota.toUpperCase()} (Plazo ${c.numero_cuotas})</option>`).join('') : '<option value="">(Sin planes)</option>';
      loadNumCuotas();
    }

    function loadNumCuotas() {
      const idCuo = document.getElementById('sel_plan').value;
      if (!idCuo || idCuo === "placeholder") return;
      const plan = db.cuotas.find(c => String(c.id_cuota) === idCuo);
      const el = document.getElementById('sel_n_cuotas');
      if(plan) {
        let opts = '<option value="" selected disabled>...</option>';
        for(let i=1; i <= plan.numero_cuotas; i++) { opts += `<option value="${i}">${i} ${i === 1 ? 'cuota' : 'cuotas'}</option>`; }
        el.innerHTML = opts;
      } else { el.innerHTML = '<option value="">-</option>'; }
      calc();
    }

    function calc() {
      const idCli = document.getElementById('sel_cliente').value;
      const idFin = document.getElementById('sel_financiera').value;
      const idCuo = document.getElementById('sel_plan').value;
      const nElegido = parseInt(document.getElementById('sel_n_cuotas').value) || 0;
      const precio = parseFloat(document.getElementById('in_precio').value) || 0;
      
      if (!idCli || idCli === "placeholder" || !idFin || idFin === "placeholder") return null;
      
      const fin = db.financieras.find(f => String(f.id_financiera) === idFin);
      const rel = db.porcentajes.find(p => String(p.id_cliente) === idCli && String(p.id_financiera) === idFin);
      const cuo = db.cuotas.find(c => String(c.id_cuota) === idCuo);
      
      if(!fin || !rel || !cuo || precio <= 0 || nElegido <= 0) { render(0,0); return null; }
      
      const cons = precio / rel.factor_cliente;
      const tasaInt = parseFloat(cuo.tasa_interes) || 0;
      const interesTotal = cons * tasaInt * nElegido;
      const cuotaBase = (cons + interesTotal) / nElegido;
      const tasaFia = parseFloat(cuo.tasa_fianza) || 0;
      const valorFianza = cuotaBase * tasaFia;
      const v_cuo = cuotaBase + valorFianza;
      
      render(cons, v_cuo);
      return { id_cliente: idCli, id_financiera: idFin, id_cuota: idCuo, precio_producto: precio, valor_a_consignar: cons, utilidad: (precio / rel.factor_cliente) - (precio / fin.factor_financiera), valor_cuota: v_cuo, total_financiado: v_cuo * nElegido, n_cuotas: nElegido };
    }

    function render(c, q) {
      const f = v => v.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
      document.getElementById('out_consignar').innerText = f(c);
      document.getElementById('out_cuota').innerText = f(q);
    }
  </script>
</body>
</html>
